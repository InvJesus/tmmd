<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Data Quality Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100%;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section-title {
            color: #4a5568;
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 3px solid #10b981;
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-drop-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-drop-zone:hover {
            border-color: #10b981;
            background: #edf2f7;
        }
        
        .file-drop-zone.dragover {
            border-color: #10b981;
            background: #e6fffa;
        }
        
        .validation-report {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .score-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        
        .error-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .error-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #f56565;
            background: #fed7d7;
            border-radius: 4px;
        }
        
        .success-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #48bb78;
            background: #c6f6d5;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .table-cell {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .table-header {
            font-weight: 600;
            color: #374151;
            background: #f8fafc;
            border-bottom: 2px solid #d1d5db;
        }
        
        .error-cell {
            background-color: #fef2f2 !important;
            border-left: 3px solid #ef4444 !important;
            position: relative;
        }
        
        .error-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }
        
        .row-number {
            background: #f1f5f9;
            font-weight: 600;
            color: #64748b;
            text-align: center;
            min-width: 50px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .table-cell {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üîß Evaluaci√≥n ETL Pentaho PDI</h1>
            <h2 style="font-size: 1.5rem; margin: 10px 0; color: rgba(255,255,255,0.95); font-weight: 500;">Universidad Tecnol√≥gica de Tec√°mac</h2>
            <p>Divisi√≥n de Tecnolog√≠as de la Informaci√≥n y Comunicaci√≥n</p>
        </header>

        <!-- Instrucciones de la Evaluaci√≥n -->
        <section class="card">
            <h2 class="section-title">üìã Instrucciones de la Evaluaci√≥n</h2>
            <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; border-left: 4px solid #0ea5e9; margin-bottom: 20px;">
                <p style="color: #0c4a6e; line-height: 1.7; margin-bottom: 15px;">
                    Como parte de la evaluaci√≥n correspondiente al proceso ETL dentro del <strong>Ciclo Big Data</strong>, se solicita al estudiante la generaci√≥n de un dataset que permita la construcci√≥n de un flujo completo de procesamiento de datos.
                </p>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #1e40af; margin: 0 0 15px 0;">üéØ Etapa 1: Limpieza y Aseguramiento de Calidad</h4>
                    <p style="color: #1e3a8a; line-height: 1.6; margin: 0;">
                        Se proporcionar√° un dataset base, junto con los archivos complementarios necesarios, a fin de que el estudiante realice las actividades de <strong>aseguramiento y mejora de la calidad de los datos</strong> mediante el uso de Pentaho PDI, corrigiendo las inconsistencias y errores detectados en la informaci√≥n.
                    </p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #1e40af; margin: 0 0 15px 0;">üèóÔ∏è Etapa 2: Construcci√≥n del Data Warehouse</h4>
                    <p style="color: #1e3a8a; line-height: 1.6; margin: 0;">
                        Una vez concluido este proceso, el estudiante deber√° validar la calidad de los datos resultantes y, posteriormente, <strong>dise√±ar y construir un Data Warehouse (DW)</strong> dentro del mismo entorno de Pentaho. Este almac√©n de datos deber√° garantizar la integraci√≥n y consolidaci√≥n de una fuente √∫nica de informaci√≥n, que respalde la confiabilidad y coherencia del conjunto de datos procesado.
                    </p>
                </div>
            </div>
            
            <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <h4 style="color: #92400e; margin: 0 0 15px 0;">üìù Pasos para Completar la Evaluaci√≥n:</h4>
                <ol style="color: #b45309; line-height: 1.8; margin: 0; padding-left: 20px;">
                    <li><strong>Generar Dataset:</strong> Completa tus datos personales y genera el dataset con errores controlados</li>
                    <li><strong>Descargar Archivos:</strong> Descarga el dataset principal y todos los archivos de referencia necesarios</li>
                    <li><strong>Procesar en Pentaho PDI:</strong> Utiliza las transformaciones sugeridas para limpiar y corregir los datos</li>
                    <li><strong>Validar Mejoras:</strong> Usa el comparador para medir la efectividad de tu proceso ETL</li>
                    <li><strong>Construir Data Warehouse:</strong> Dise√±a el esquema dimensional y carga los datos limpios</li>
                    <li><strong>Entregar Resultados:</strong> Presenta tanto el dataset limpio como la estructura del DW</li>
                </ol>
            </div>
        </section>

        <!-- Generaci√≥n de Dataset -->
        <main class="card">
            <h2 class="section-title">üìä Generador de Dataset</h2>
            
            <form id="datasetForm" class="form-grid">
                <div class="form-group">
                    <label for="studentName">Nombre del Estudiante</label>
                    <input type="text" id="studentName" placeholder="Nombre completo del estudiante" required>
                </div>
                
                <div class="form-group">
                    <label for="studentGroup">Grupo</label>
                    <input type="text" id="studentGroup" placeholder="Ej: 7IRI1, BD-2024-A, etc." required>
                </div>
                
                <div class="form-group">
                    <label for="numRecords">N√∫mero de Registros</label>
                    <input type="number" id="numRecords" min="100" max="10000" value="1000" required>
                </div>
                
                <div class="form-group">
                    <label for="errorPercentage">Porcentaje de Errores (%)</label>
                    <input type="number" id="errorPercentage" min="5" max="50" value="20" required>
                </div>
                
                <div class="form-group">
                    <label for="fileFormat">Formato de Archivo</label>
                    <select id="fileFormat" required>
                        <option value="csv">CSV</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="datasetName">Nombre del Dataset</label>
                    <input type="text" id="datasetName" placeholder="dataset_evaluacion" required>
                </div>
            </form>
            
            <button type="button" class="btn" onclick="generateDataset()">
                üé≤ Generar Dataset con Errores
            </button>
            
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="generationStatus"></div>
            
            <div id="datasetViewer" class="hidden" style="margin-top: 20px;">
                <div id="datasetInfo" style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #0ea5e9;">
                    <h3 style="color: #0c4a6e; margin: 0 0 10px 0;">üìä Dataset Generado</h3>
                    <div id="datasetStats"></div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="downloadDataset()">
                        üì• Descargar Dataset
                    </button>
                    <button type="button" class="btn" onclick="generateDatasetPDF()" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                        üìÑ Generar Reporte PDF
                    </button>
                </div>
                
                <div id="tableContainer" style="max-height: 500px; overflow: auto; border: 2px solid #e2e8f0; border-radius: 8px; background: white;">
                    <table id="datasetTable" style="width: 100%; border-collapse: collapse;">
                        <thead id="tableHeader" style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="errorSummary" style="margin-top: 20px; padding: 15px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                    <h4 style="color: #991b1b; margin: 0 0 10px 0;">üö® Errores Detectados en el Dataset</h4>
                    <div id="errorList"></div>
                </div>
                
                <div id="solutionGuide" style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 12px; border: 2px solid #0ea5e9;">
                    <h4 style="color: #0c4a6e; margin: 0 0 15px 0;">üîß Gu√≠a de Soluciones para Pentaho PDI</h4>
                    <div id="solutionList"></div>
                    
                    <div id="referenceFilesSection" class="hidden" style="margin-top: 25px; padding: 20px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                        <h5 style="color: #065f46; margin: 0 0 15px 0;">üìÅ Archivos de Referencia Necesarios</h5>
                        <p style="color: #047857; margin-bottom: 15px;">Para resolver errores de integridad l√≥gica, necesitar√°s estos archivos complementarios:</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" onclick="downloadReferenceFile('ciudades_estados')">
                                üì• Descargar ciudades_estados
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="downloadReferenceFile('departamentos_validos')">
                                üì• Descargar departamentos_validos
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="downloadReferenceFile('paises_validos')">
                                üì• Descargar paises_validos
                            </button>
                            <button type="button" class="btn" onclick="downloadBackupData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                üóÇÔ∏è Descargar Datos de Respaldo
                            </button>
                        </div>
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 6px; border-left: 3px solid #10b981;">
                            <strong>üí° Uso en Pentaho PDI:</strong>
                            <ol style="margin: 10px 0 0 20px; line-height: 1.6;">
                                <li>Descarga los archivos de referencia necesarios (mismo formato que tu dataset)</li>
                                <li>Col√≥calos en la misma carpeta que tu transformaci√≥n PDI</li>
                                <li>Usa "Text file input" (CSV) o "Excel input" (XLSX) para cargar cada archivo de referencia</li>
                                <li>Conecta con "Stream lookup" para validar y corregir datos</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                        <h5 style="color: #92400e; margin: 0 0 15px 0;">üóÇÔ∏è Archivo de Datos de Respaldo</h5>
                        <p style="color: #b45309; margin-bottom: 15px;">
                            <strong>¬°IMPORTANTE!</strong> El archivo de "Datos de Respaldo" contiene √öNICAMENTE:
                        </p>
                        <ul style="color: #b45309; margin: 10px 0 15px 20px; line-height: 1.6;">
                            <li><strong>Valores faltantes (missing)</strong> que se perdieron durante la captura</li>
                            <li><strong>Valores originales correctos</strong> para campos que aparecen vac√≠os o nulos</li>
                            <li><strong>Mapeo exacto</strong> de qu√© registro y campo necesita qu√© valor</li>
                        </ul>
                        <div style="background: #fffbeb; padding: 15px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                            <strong>üí° Filosof√≠a del archivo de respaldo:</strong>
                            <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                                <li><strong>Solo valores faltantes:</strong> Los dem√°s errores (formato, rango, c√°lculos) deben resolverse con l√≥gica ETL</li>
                                <li><strong>Uso en PDI:</strong> "Text file input" + "Stream lookup" para restaurar valores perdidos</li>
                                <li><strong>Pr√°ctica real:</strong> En producci√≥n solo tendr√≠as acceso a datos perdidos, no a correcciones autom√°ticas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Comparador de Mejoras ETL -->
        <section class="card">
            <h2 class="section-title">üîÑ Comparador de Mejoras ETL</h2>
            <p style="color: #64748b; margin-bottom: 25px;">Compara tu archivo original con el resultado procesado en Pentaho PDI para medir la mejora en calidad de datos</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Archivo Original -->
                <div>
                    <h3 style="color: #dc2626; margin-bottom: 15px;">üìÑ 1. Archivo Original (con errores)</h3>
                    <div class="file-drop-zone" id="originalDropZone" onclick="document.getElementById('originalFileInput').click()">
                        <div>
                            <h4>üìÅ Sube archivo original</h4>
                            <p>Dataset con errores generado</p>
                            <input type="file" id="originalFileInput" accept=".csv,.xlsx" class="hidden">
                        </div>
                    </div>
                    <div id="originalStatus" style="margin-top: 10px; font-size: 0.9rem; color: #64748b;"></div>
                </div>
                
                <!-- Archivo Procesado -->
                <div>
                    <h3 style="color: #059669; margin-bottom: 15px;">‚úÖ 2. Archivo Procesado (Pentaho PDI)</h3>
                    <div class="file-drop-zone" id="processedDropZone" onclick="document.getElementById('processedFileInput').click()">
                        <div>
                            <h4>üìÅ Sube archivo procesado</h4>
                            <p>Resultado despu√©s de Pentaho</p>
                            <input type="file" id="processedFileInput" accept=".csv,.xlsx" class="hidden">
                        </div>
                    </div>
                    <div id="processedStatus" style="margin-top: 10px; font-size: 0.9rem; color: #64748b;"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button type="button" class="btn" id="compareBtn" onclick="compareDatasets()" disabled>
                    üîç Comparar y Analizar Mejoras
                </button>
                <button type="button" class="btn" id="comparePDFBtn" onclick="generateComparisonPDF()" disabled style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-left: 10px;">
                    üìÑ Generar Reporte PDF
                </button>
            </div>
            
            <!-- Resultados de Comparaci√≥n -->
            <div id="comparisonResults" class="hidden">
                <!-- Indicador de Mejora Principal -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.8rem;">üéØ Resultado de la Mejora ETL</h3>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap;">
                        <div>
                            <div id="improvementPercentage" style="font-size: 3.5rem; font-weight: bold; margin-bottom: 5px;">+0.0%</div>
                            <div style="font-size: 1.1rem; opacity: 0.9;">% de Errores Corregidos</div>
                        </div>
                        <div style="font-size: 2rem;">‚Üí</div>
                        <div>
                            <div style="display: flex; gap: 20px;">
                                <div>
                                    <div id="originalErrorCount" style="font-size: 2rem; font-weight: bold;">0</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Errores Originales</div>
                                </div>
                                <div>
                                    <div id="processedErrorCount" style="font-size: 2rem; font-weight: bold;">0</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8;">Errores Restantes</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div id="correctionSummary" style="font-size: 1.1rem; opacity: 0.95;">
                            Errores corregidos: <span id="errorsCorrectedCount" style="font-weight: bold;">0</span> de <span id="totalOriginalErrors" style="font-weight: bold;">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Comparaci√≥n Detallada -->
                <div id="detailedComparison"></div>
                
                <!-- Recomendaciones de Mejora -->
                <div id="improvementRecommendations"></div>
            </div>
        </section>

        <!-- Validador Individual (Mantener funcionalidad existente) -->
        <section class="card">
            <h2 class="section-title">‚úÖ Validador Individual de Dataset</h2>
            <p style="color: #64748b; margin-bottom: 20px;">Valida un solo archivo para an√°lisis de calidad independiente</p>
            
            <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div>
                    <h3>üìÅ Sube tu archivo para validar</h3>
                    <p>Arrastra y suelta tu archivo CSV/XLSX aqu√≠ o haz clic para seleccionar</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx" class="hidden">
                </div>
            </div>
            
            <div id="validationResults" class="hidden">
                <div class="validation-report">
                    <div class="score-display">
                        <div id="scoreCircle" class="score-circle">
                            <span id="scoreText">0%</span>
                        </div>
                        <h3 id="scoreLabel">Puntuaci√≥n de Calidad</h3>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="btn" id="validationPDFBtn" onclick="generateValidationPDF()" disabled style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); opacity: 0.6;">
                            üìÑ Generar Reporte PDF
                        </button>
                    </div>
                    
                    <div id="errorReport" class="error-list"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Configuraci√≥n global
        let currentDataset = null;
        let originalErrors = [];
        let originalDataset = null;
        let processedDataset = null;
        
        // Funci√≥n para extraer informaci√≥n del estudiante desde el nombre del archivo
        function extractStudentInfoFromFilename(fileName) {
            try {
                console.log('=== EXTRAYENDO INFORMACI√ìN DEL ESTUDIANTE ===');
                console.log('Nombre del archivo completo:', fileName);
                
                // Patr√≥n principal: Nombre-_Jesus Romero Moreno_-Grupo-_7IRI1_-Tipo-_Eva2do
                const mainPattern = /Nombre-_([^_]+)_-Grupo-_([^_]+)_-Tipo-_([^_]+)/;
                const mainMatch = fileName.match(mainPattern);
                
                if (mainMatch) {
                    const studentInfo = {
                        studentName: mainMatch[1].trim(),
                        studentGroup: mainMatch[2].trim(),
                        fileType: mainMatch[3].trim(),
                        hasInfo: true,
                        fileName: fileName,
                        extractionMethod: 'Patr√≥n principal con guiones bajos'
                    };
                    
                    console.log('‚úÖ INFORMACI√ìN EXTRA√çDA EXITOSAMENTE (Patr√≥n principal):');
                    console.log('- Estudiante:', studentInfo.studentName);
                    console.log('- Grupo:', studentInfo.studentGroup);
                    console.log('- Tipo de archivo:', studentInfo.fileType);
                    console.log('- Archivo completo:', studentInfo.fileName);
                    
                    return studentInfo;
                }
                
                // Patr√≥n alternativo con comillas: Nombre-"Jesus Romero Moreno"-Grupo-"7IRI1"-Tipo-"Eva2do"
                const quotesPattern = /Nombre-"([^"]+)"-Grupo-"([^"]+)"-Tipo-"([^"]+)"/;
                const quotesMatch = fileName.match(quotesPattern);
                
                if (quotesMatch) {
                    const studentInfo = {
                        studentName: quotesMatch[1].trim(),
                        studentGroup: quotesMatch[2].trim(),
                        fileType: quotesMatch[3].trim(),
                        hasInfo: true,
                        fileName: fileName,
                        extractionMethod: 'Patr√≥n con comillas'
                    };
                    
                    console.log('‚úÖ INFORMACI√ìN EXTRA√çDA EXITOSAMENTE (Patr√≥n con comillas):');
                    console.log('- Estudiante:', studentInfo.studentName);
                    console.log('- Grupo:', studentInfo.studentGroup);
                    console.log('- Tipo de archivo:', studentInfo.fileType);
                    console.log('- Archivo completo:', studentInfo.fileName);
                    
                    return studentInfo;
                }
                
                console.log('‚ùå PATRONES PRINCIPALES NO ENCONTRADOS - Intentando extracci√≥n alternativa...');
                
                // Intentar patrones alternativos m√°s flexibles
                const alternativePatterns = [
                    // Patr√≥n con cualquier delimitador entre etiquetas
                    {
                        pattern: /Nombre[^a-zA-Z0-9]*([^-_]+)[^a-zA-Z0-9]*Grupo[^a-zA-Z0-9]*([^-_]+)[^a-zA-Z0-9]*Tipo[^a-zA-Z0-9]*([^.]+)/i,
                        name: 'Patr√≥n flexible con etiquetas'
                    },
                    // Patr√≥n simple: tres segmentos separados por guiones
                    {
                        pattern: /^([^-]+)-([^-]+)-([^.]+)/,
                        name: 'Patr√≥n simple con guiones'
                    },
                    // Patr√≥n con guiones bajos
                    {
                        pattern: /^([^_]+)_([^_]+)_([^.]+)/,
                        name: 'Patr√≥n simple con guiones bajos'
                    }
                ];
                
                for (let i = 0; i < alternativePatterns.length; i++) {
                    const altMatch = fileName.match(alternativePatterns[i].pattern);
                    if (altMatch) {
                        console.log(`‚úÖ ${alternativePatterns[i].name.toUpperCase()} ENCONTRADO:`, altMatch);
                        
                        // Para el patr√≥n flexible, extraer solo el contenido despu√©s de las etiquetas
                        let studentName, studentGroup, fileType;
                        
                        if (i === 0) { // Patr√≥n flexible con etiquetas
                            studentName = altMatch[1].replace(/^[^a-zA-Z0-9]*|[^a-zA-Z0-9]*$/g, '').trim();
                            studentGroup = altMatch[2].replace(/^[^a-zA-Z0-9]*|[^a-zA-Z0-9]*$/g, '').trim();
                            fileType = altMatch[3].replace(/^[^a-zA-Z0-9]*|[^a-zA-Z0-9]*$/g, '').trim();
                        } else {
                            studentName = altMatch[1].trim();
                            studentGroup = altMatch[2].trim();
                            fileType = altMatch[3].replace(/\.(csv|xlsx)$/i, '').trim();
                        }
                        
                        return {
                            studentName: studentName || 'Estudiante no identificado',
                            studentGroup: studentGroup || 'Grupo no identificado',
                            fileType: fileType || fileName.replace(/\.(csv|xlsx)$/i, ''),
                            hasInfo: true,
                            fileName: fileName,
                            extractionMethod: alternativePatterns[i].name
                        };
                    }
                }
                
                // Si no se encuentra ning√∫n patr√≥n, usar informaci√≥n b√°sica
                const baseName = fileName.replace(/\.(csv|xlsx)$/i, '');
                console.log('‚ö†Ô∏è USANDO INFORMACI√ìN B√ÅSICA DEL ARCHIVO:', baseName);
                
                return {
                    studentName: 'Estudiante no identificado',
                    studentGroup: 'Grupo no identificado',
                    fileType: baseName,
                    hasInfo: false,
                    fileName: fileName,
                    extractionMethod: 'Informaci√≥n b√°sica'
                };
                
            } catch (error) {
                console.error('‚ùå ERROR AL EXTRAER INFORMACI√ìN:', error);
                return {
                    studentName: 'Error en extracci√≥n',
                    studentGroup: 'Error en extracci√≥n',
                    fileType: fileName,
                    hasInfo: false,
                    fileName: fileName,
                    error: error.message
                };
            }
        }
        
        // Configurar Faker en espa√±ol (sintaxis v3.1.0)
        faker.locale = 'es';
        
        // Tipos de errores que se pueden generar (7 tipos principales)
        const ERROR_TYPES = {
            MISSING: 'missing',
            INVALID_FORMAT: 'invalid_format',
            OUT_OF_RANGE: 'out_of_range',
            DUPLICATE: 'duplicate',
            CALCULATION_ERROR: 'calculation_error',
            UNIT_MISMATCH: 'unit_mismatch',
            FALSE_REFERENTIAL_INTEGRITY: 'false_referential_integrity'
        };
        
        // Funci√≥n para generar RFC v√°lido seg√∫n normatividad mexicana
        function generateValidRFC(name, birthDate) {
            const date = new Date(birthDate);
            
            // Separar nombre completo
            const nameParts = name.split(' ');
            const apellidoPaterno = nameParts[0] || 'XXXX';
            const apellidoMaterno = nameParts[1] || 'X';
            const nombres = nameParts.slice(2).join(' ') || 'X';
            
            // Primeras 2 letras del apellido paterno
            const firstTwo = apellidoPaterno.substring(0, 2).toUpperCase();
            
            // Primera vocal interna del apellido paterno
            const vowels = 'AEIOU';
            let firstVowel = 'X';
            for (let i = 1; i < apellidoPaterno.length; i++) {
                if (vowels.includes(apellidoPaterno[i].toUpperCase())) {
                    firstVowel = apellidoPaterno[i].toUpperCase();
                    break;
                }
            }
            
            // Primera letra del apellido materno
            const maternalInitial = apellidoMaterno.substring(0, 1).toUpperCase();
            
            // Primera letra del primer nombre
            const nameInitial = nombres.substring(0, 1).toUpperCase();
            
            // Fecha de nacimiento (AAMMDD)
            const year = date.getFullYear().toString().slice(-2).padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            // Homoclave (2 caracteres alfanum√©ricos)
            const alphanumeric = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const homoclave = Array.from({length: 2}, () => alphanumeric[Math.floor(Math.random() * alphanumeric.length)]).join('');
            
            // D√≠gito verificador (0-9)
            const verifier = Math.floor(Math.random() * 10).toString();
            
            return `${firstTwo}${firstVowel}${maternalInitial}${year}${month}${day}${homoclave}${verifier}`;
        }
        
        // Funci√≥n para generar CURP v√°lido seg√∫n normatividad mexicana
        function generateValidCURP(name, birthDate, gender = null) {
            const date = new Date(birthDate);
            
            // Separar nombre completo
            const nameParts = name.split(' ');
            const apellidoPaterno = nameParts[0] || 'XXXX';
            const apellidoMaterno = nameParts[1] || 'X';
            const nombres = nameParts.slice(2).join(' ') || 'X';
            
            // Primeras 2 letras del apellido paterno
            const firstTwo = apellidoPaterno.substring(0, 2).toUpperCase();
            
            // Primera vocal interna del apellido paterno
            const vowels = 'AEIOU';
            let firstVowel = 'X';
            for (let i = 1; i < apellidoPaterno.length; i++) {
                if (vowels.includes(apellidoPaterno[i].toUpperCase())) {
                    firstVowel = apellidoPaterno[i].toUpperCase();
                    break;
                }
            }
            
            // Primera letra del apellido materno
            const maternalInitial = apellidoMaterno.substring(0, 1).toUpperCase();
            
            // Primera letra del primer nombre
            const nameInitial = nombres.substring(0, 1).toUpperCase();
            
            // Fecha de nacimiento (AAMMDD)
            const year = date.getFullYear().toString().slice(-2).padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            // Sexo (H/M)
            const genderCode = gender || (Math.random() > 0.5 ? 'H' : 'M');
            
            // Estado de nacimiento (2 letras)
            const states = ['AS', 'BC', 'BS', 'CC', 'CL', 'CM', 'CS', 'CH', 'DF', 'DG', 'GT', 'GR', 'HG', 'JC', 'MC', 'MN', 'MS', 'NT', 'NL', 'OC', 'PL', 'QT', 'QR', 'SP', 'SL', 'SR', 'TC', 'TS', 'TL', 'VZ', 'YN', 'ZS'];
            const state = states[Math.floor(Math.random() * states.length)];
            
            // Consonantes internas (3 letras, solo consonantes)
            const consonants = 'BCDFGHJKLMNPQRSTVWXYZ';
            
            // Primera consonante interna del apellido paterno (despu√©s de la primera letra)
            let firstConsonant = 'X';
            for (let i = 1; i < apellidoPaterno.length; i++) {
                if (consonants.includes(apellidoPaterno[i].toUpperCase())) {
                    firstConsonant = apellidoPaterno[i].toUpperCase();
                    break;
                }
            }
            
            // Primera consonante interna del apellido materno
            let secondConsonant = 'X';
            for (let i = 1; i < apellidoMaterno.length; i++) {
                if (consonants.includes(apellidoMaterno[i].toUpperCase())) {
                    secondConsonant = apellidoMaterno[i].toUpperCase();
                    break;
                }
            }
            
            // Primera consonante interna del nombre
            let thirdConsonant = 'X';
            for (let i = 1; i < nombres.length; i++) {
                if (consonants.includes(nombres[i].toUpperCase())) {
                    thirdConsonant = nombres[i].toUpperCase();
                    break;
                }
            }
            
            // Homoclave (1 car√°cter alfanum√©rico)
            const alphanumeric = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const homoclave = alphanumeric[Math.floor(Math.random() * alphanumeric.length)];
            
            // D√≠gito verificador (0-9)
            const verifier = Math.floor(Math.random() * 10).toString();
            
            return `${firstTwo}${firstVowel}${maternalInitial}${year}${month}${day}${genderCode}${state}${firstConsonant}${secondConsonant}${thirdConsonant}${homoclave}${verifier}`;
        }
        
        function generateDataset() {
            const numRecords = parseInt(document.getElementById('numRecords').value);
            const errorPercentage = parseInt(document.getElementById('errorPercentage').value);
            const fileFormat = document.getElementById('fileFormat').value;
            const datasetName = document.getElementById('datasetName').value;
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            
            if (!datasetName || !studentName || !studentGroup || !numRecords) {
                showStatus('Por favor completa todos los campos requeridos', 'error');
                return;
            }
            
            if (numRecords < 100 || numRecords > 10000) {
                showStatus('El n√∫mero de registros debe estar entre 100 y 10,000', 'error');
                return;
            }
            
            showProgress(true);
            showStatus('Generando dataset con errores controlados...', 'success');
            
            // Simular progreso
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                updateProgress(progress);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        createDatasetWithErrors(numRecords, errorPercentage, fileFormat, datasetName, studentName, studentGroup);
                        showProgress(false);
                    }, 500);
                }
            }, 200);
        }
        
        function createDatasetWithErrors(numRecords, errorPercentage, format, name, student, group) {
            const data = [];
            originalErrors = [];
            
            console.log(`Iniciando generaci√≥n de dataset con ${numRecords} registros...`);
            
            // Generar registros base con estructura mejorada
            for (let i = 0; i < numRecords; i++) {
                const productPrice = faker.random.number({ min: 10, max: 500 });
                const productQuantity = faker.random.number({ min: 1, max: 10 });
                const productTotal = productPrice * productQuantity;
                
                // Datos espec√≠ficos de M√©xico
                const mexicanCities = [
                    'Ciudad de M√©xico', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 
                    'Le√≥n', 'Ju√°rez', 'Torre√≥n', 'Quer√©taro', 'San Luis Potos√≠',
                    'M√©rida', 'Mexicali', 'Aguascalientes', 'Cuernavaca', 'Saltillo',
                    'Hermosillo', 'Culiac√°n', 'Durango', 'Toluca', 'Tampico'
                ];
                
                const mexicanStates = [
                    'CDMX', 'Jalisco', 'Nuevo Le√≥n', 'Puebla', 'Baja California',
                    'Guanajuato', 'Chihuahua', 'Coahuila', 'Quer√©taro', 'San Luis Potos√≠',
                    'Yucat√°n', 'Baja California Sur', 'Aguascalientes', 'Morelos', 'Coahuila',
                    'Sonora', 'Sinaloa', 'Durango', 'Estado de M√©xico', 'Tamaulipas'
                ];
                
                const mexicanNames = [
                    'Jos√© Luis Garc√≠a L√≥pez', 'Mar√≠a Elena Rodr√≠guez Mart√≠nez', 'Carlos Alberto Hern√°ndez P√©rez',
                    'Ana Patricia Gonz√°lez S√°nchez', 'Miguel √Ångel Ram√≠rez Torres', 'Claudia Alejandra Flores Morales',
                    'Roberto Carlos Jim√©nez Ruiz', 'Silvia Guadalupe Castro Vargas', 'Fernando Javier Moreno Ortiz',
                    'Leticia Esperanza Guti√©rrez Mendoza', 'Alejandro Daniel V√°zquez Aguilar', 'Rosa Mar√≠a Delgado Cruz',
                    'Arturo Enrique Medina Reyes', 'Gabriela Cristina Romero Herrera', 'Ricardo Antonio Guerrero N√∫√±ez'
                ];
                
                const mexicanProducts = [
                    'Tacos de Carnitas', 'Quesadillas de Flor de Calabaza', 'Pozole Rojo', 'Chiles en Nogada',
                    'Mole Poblano', 'Cochinita Pibil', 'Tamales Oaxaque√±os', 'Enchiladas Verdes',
                    'Sopa de Tortilla', 'Guacamole Tradicional', 'Elote Preparado', 'Churros con Cajeta',
                    'Caf√© de Olla', 'Horchata de Arroz', 'Agua de Jamaica', 'Mezcal Artesanal',
                    'Tequila Reposado', 'Chocolate Abuelita', 'Pan de Muerto', 'Tres Leches'
                ];
                
                const selectedCity = faker.random.arrayElement(mexicanCities);
                const selectedState = mexicanStates[mexicanCities.indexOf(selectedCity)];
                
                const customerName = faker.random.arrayElement(mexicanNames);
                const birthDate = faker.date.past(50, new Date(2000, 0, 1));
                const gender = Math.random() > 0.5 ? 'H' : 'M';
                
                const record = {
                    id: i + 1,
                    customer_name: customerName,
                    email: faker.internet.email(),
                    phone: `+52 ${faker.random.number({ min: 10, max: 99 })} ${faker.random.number({ min: 1000, max: 9999 })} ${faker.random.number({ min: 1000, max: 9999 })}`,
                    birth_date: birthDate.toISOString().split('T')[0],
                    age: faker.random.number({ min: 18, max: 65 }),
                    salary: faker.random.number({ min: 8000, max: 80000 }), // Salarios en pesos mexicanos
                    department: faker.random.arrayElement(['Ventas', 'Marketing', 'Sistemas', 'Recursos Humanos', 'Finanzas', 'Operaciones']),
                    city: selectedCity,
                    state: selectedState,
                    country: 'M√©xico',
                    postal_code: faker.random.number({ min: 10000, max: 99999 }).toString(),
                    product_name: faker.random.arrayElement(mexicanProducts),
                    product_price: productPrice, // Precios en pesos mexicanos
                    product_quantity: productQuantity,
                    product_total: productTotal,
                    order_date: faker.date.recent(30).toISOString().split('T')[0],
                    active: faker.random.boolean() ? 'S√≠' : 'No',
                    rfc: generateValidRFC(customerName, birthDate),
                    curp: generateValidCURP(customerName, birthDate, gender)
                };
                data.push(record);
            }
            
            console.log(`Generados ${data.length} registros base`);
            
            // Aplicar errores controlados
            const numErrorRecords = Math.floor((data.length * errorPercentage) / 100);
            // Crear array de √≠ndices y mezclar manualmente (faker.helpers.shuffle no existe en v3.1.0)
            const allIndices = [];
            for (let i = 0; i < data.length; i++) {
                allIndices.push(i);
            }
            // Mezclar array manualmente
            for (let i = allIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allIndices[i], allIndices[j]] = [allIndices[j], allIndices[i]];
            }
            const errorIndices = allIndices.slice(0, numErrorRecords);
            
            console.log(`Aplicando ${numErrorRecords} errores...`);
            
            errorIndices.forEach(index => {
                const errorType = faker.random.arrayElement(Object.values(ERROR_TYPES));
                applyError(data, index, errorType);
            });
            
            console.log(`Errores aplicados: ${originalErrors.length}`);
            
            // Crear archivo de datos de respaldo con valores originales
            const backupData = createBackupDataFile(data, originalErrors);
            
            // Guardar referencia del dataset actual
            currentDataset = {
                data: data,
                errors: originalErrors,
                backupData: backupData,
                metadata: {
                    name: name,
                    student: student,
                    group: group,
                    numRecords: numRecords,
                    errorPercentage: errorPercentage,
                    totalRecords: data.length,
                    errorRecords: numErrorRecords
                }
            };
            
            console.log('Dataset creado, mostrando visor...');
            
            // Mostrar visor de dataset
            showDatasetViewer(data, format, name, numErrorRecords, errorPercentage);
        }
        
        // Funci√≥n para crear archivo de datos de respaldo SOLO con valores faltantes
        function createBackupDataFile(data, errors) {
            const backupRecords = [];
            
            // SOLO incluir errores de tipo 'missing' (valores faltantes)
            const missingValueErrors = errors.filter(error => error.type === ERROR_TYPES.MISSING);
            
            missingValueErrors.forEach(error => {
                const record = data[error.index];
                
                // Buscar valor original guardado
                const originalFieldName = `${error.field}_original`;
                if (record[originalFieldName] !== undefined && record[originalFieldName] !== null && record[originalFieldName] !== '') {
                    const backupRecord = {
                        registro_id: error.index + 1,
                        campo_faltante: error.field,
                        valor_correcto: record[originalFieldName],
                        descripcion: `Valor original para ${error.field} que se perdi√≥ durante la captura de datos`,
                        instruccion_etl: `Usar Stream Lookup o Value Mapper para restaurar este valor desde el archivo de respaldo`
                    };
                    
                    backupRecords.push(backupRecord);
                }
            });
            
            return backupRecords;
        }
        
        function generateCSVContent(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            // Agregar encabezados
            csvRows.push(headers.join(','));
            
            // Agregar datos
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    
                    // Manejar valores nulos
                    if (value === null || value === undefined) {
                        return '';
                    }
                    
                    // Convertir a string y escapar
                    const stringValue = String(value);
                    
                    // Si contiene comas, comillas o saltos de l√≠nea, envolver en comillas
                    if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    
                    return stringValue;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function showDatasetViewer(data, format, name, numErrorRecords, errorPercentage) {
            const viewer = document.getElementById('datasetViewer');
            const stats = document.getElementById('datasetStats');
            const fileName = `${name}.${format}`;
            
            // Mostrar estad√≠sticas
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            
            stats.innerHTML = `
                <p style="margin: 5px 0; color: #0369a1;"><strong>Estudiante:</strong> ${studentName}</p>
                <p style="margin: 5px 0; color: #0369a1;"><strong>Grupo:</strong> ${studentGroup}</p>
                <p style="margin: 5px 0; color: #0369a1;"><strong>Archivo:</strong> ${fileName}</p>
                <p style="margin: 5px 0; color: #0369a1;"><strong>Registros:</strong> ${data.length}</p>
                <p style="margin: 5px 0; color: #0369a1;"><strong>Errores:</strong> ${numErrorRecords} (${errorPercentage}%)</p>
            `;
            
            // Generar tabla
            generateDataTable(data);
            
            // Mostrar resumen de errores
            showErrorSummary();
            
            viewer.classList.remove('hidden');
            showStatus(`‚úÖ Dataset generado y mostrado con ${numErrorRecords} errores (${errorPercentage}%)`, 'success');
        }
        
        function generateDataTable(data) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            if (!data || data.length === 0) return;
            
            // Generar encabezados
            const headers = Object.keys(data[0]);
            tableHeader.innerHTML = `
                <tr>
                    <th class="table-cell table-header row-number">#</th>
                    ${headers.map(header => `<th class="table-cell table-header">${header}</th>`).join('')}
                </tr>
            `;
            
            // Generar filas (mostrar solo primeras 100 para rendimiento)
            const displayData = data.slice(0, 100);
            tableBody.innerHTML = displayData.map((row, displayIndex) => {
                // Buscar errores para este registro espec√≠fico
                const recordErrors = originalErrors.filter(error => error.index === displayIndex);
                return `
                    <tr>
                        <td class="table-cell row-number">${displayIndex + 1}</td>
                        ${headers.map(header => {
                            const hasError = recordErrors.some(error => error.field === header);
                            const cellClass = hasError ? 'table-cell error-cell' : 'table-cell';
                            const indicator = hasError ? '<div class="error-indicator"></div>' : '';
                            const cellValue = row[header] === null || row[header] === undefined ? '' : row[header];
                            return `<td class="${cellClass}" style="position: relative;">${cellValue}${indicator}</td>`;
                        }).join('')}
                    </tr>
                `;
            }).join('');
            
            if (data.length > 100) {
                tableBody.innerHTML += `
                    <tr>
                        <td colspan="${headers.length + 1}" class="table-cell" style="text-align: center; font-style: italic; color: #666;">
                            ... y ${data.length - 100} registros m√°s (usa la descarga para ver todos)
                        </td>
                    </tr>
                `;
            }
        }
        
        function showErrorSummary() {
            const errorList = document.getElementById('errorList');
            const solutionList = document.getElementById('solutionList');
            
            if (originalErrors.length === 0) {
                errorList.innerHTML = '<p>No se encontraron errores en el dataset.</p>';
                solutionList.innerHTML = '<p>No hay errores que corregir.</p>';
                return;
            }
            
            const errorsByType = {};
            originalErrors.forEach(error => {
                if (!errorsByType[error.type]) {
                    errorsByType[error.type] = [];
                }
                errorsByType[error.type].push(error);
            });
            
            errorList.innerHTML = Object.keys(errorsByType).map(type => `
                <div style="margin-bottom: 15px;">
                    <strong>${getErrorTypeName(type)}:</strong> ${errorsByType[type].length} errores
                    <ul style="margin: 5px 0 0 20px; font-size: 0.9rem;">
                        ${errorsByType[type].slice(0, 3).map(error => 
                            `<li>
                                <strong>Registro ${error.index + 1}, campo "${error.field}":</strong> ${error.description}
                                ${error.solutionHint ? `<br><span style="color: #059669; font-style: italic;">üí° ${error.solutionHint}</span>` : ''}
                            </li>`
                        ).join('')}
                        ${errorsByType[type].length > 3 ? `<li><em>... y ${errorsByType[type].length - 3} m√°s</em></li>` : ''}
                    </ul>
                </div>
            `).join('');
            
            // Generar gu√≠a de soluciones para Pentaho PDI
            solutionList.innerHTML = Object.keys(errorsByType).map(type => 
                getPentahoSolution(type, errorsByType[type])
            ).join('');
            
            // Mostrar secci√≥n de archivos de referencia si hay errores de integridad
            if (errorsByType['false_referential_integrity']) {
                document.getElementById('referenceFilesSection').classList.remove('hidden');
            }
        }
        
        function getErrorTypeName(type) {
            const names = {
                'missing': 'Valores Faltantes',
                'invalid_format': 'Formato Inv√°lido',
                'out_of_range': 'Fuera de Rango',
                'duplicate': 'Duplicados',
                'calculation_error': 'Error de C√°lculo',
                'unit_mismatch': 'Unidad/Moneda Incorrecta',
                'false_referential_integrity': 'Integridad L√≥gica Falsa'
            };
            return names[type] || type;
        }
        
        function getPentahoSolution(errorType, errors) {
            const solutions = {
                'missing': {
                    title: 'üîß Soluci√≥n para Valores Faltantes',
                    steps: [
                        '<strong>Step 1:</strong> Usar "If field value is null" para detectar campos vac√≠os',
                        '<strong>Step 2:</strong> Aplicar "Set field value" con valores por defecto:',
                        '‚Ä¢ email faltante ‚Üí "sin_email@empresa.com"',
                        '‚Ä¢ phone faltante ‚Üí "000-000-0000"',
                        '‚Ä¢ customer_name faltante ‚Üí "Cliente An√≥nimo"',
                        '‚Ä¢ city faltante ‚Üí usar el valor m√°s frecuente del dataset',
                        '<strong>Step 3:</strong> Usar "Value Mapper" para estandarizar valores nulos'
                    ],
                    components: ['If field value is null', 'Set field value', 'Value Mapper'],
                    validation: 'Verificar que no queden campos NULL despu√©s del procesamiento'
                },
                'invalid_format': {
                    title: 'üîß Soluci√≥n para Formato Inv√°lido',
                    steps: [
                        '<strong>Step 1:</strong> Usar "Regex Evaluation" para validar formatos:',
                        '‚Ä¢ Email: patr√≥n ^[^@]+@[^@]+\\.[^@]+$',
                        '‚Ä¢ Tel√©fono: longitud m√≠nima 7 caracteres',
                        '‚Ä¢ Fecha: formato YYYY-MM-DD',
                        '<strong>Step 2:</strong> "Replace in string" para corregir formatos comunes:',
                        '‚Ä¢ Agregar "@empresa.com" a emails incompletos',
                        '‚Ä¢ Completar tel√©fonos cortos con "000" al inicio',
                        '<strong>Step 3:</strong> "Select values" para convertir tipos de datos correctamente'
                    ],
                    components: ['Regex Evaluation', 'Replace in string', 'Select values', 'Calculator'],
                    validation: 'Usar "Filter rows" para separar registros v√°lidos de inv√°lidos'
                },
                'out_of_range': {
                    title: 'üîß Soluci√≥n para Fuera de Rango',
                    steps: [
                        '<strong>Step 1:</strong> "Filter rows" para identificar valores fuera de rango:',
                        '‚Ä¢ Edad: 18 ‚â§ edad ‚â§ 100',
                        '‚Ä¢ Salario: 15,000 ‚â§ salario ‚â§ 200,000',
                        '‚Ä¢ Precio: 1 ‚â§ precio ‚â§ 5,000',
                        '<strong>Step 2:</strong> "Calculator" para ajustar valores extremos:',
                        '‚Ä¢ Edad > 100 ‚Üí calcular desde birth_date',
                        '‚Ä¢ Salario excesivo ‚Üí dividir entre 100 (error de unidad)',
                        '<strong>Step 3:</strong> "If field value" para aplicar l√≠mites m√°ximos/m√≠nimos'
                    ],
                    components: ['Filter rows', 'Calculator', 'If field value', 'Select values'],
                    validation: 'Verificar que todos los valores est√©n dentro de rangos l√≥gicos'
                },
                'duplicate': {
                    title: 'üîß Soluci√≥n para Duplicados',
                    steps: [
                        '<strong>Step 1:</strong> "Sort rows" por campo ID para agrupar duplicados',
                        '<strong>Step 2:</strong> "Add sequence" para generar nuevos IDs √∫nicos',
                        '<strong>Step 3:</strong> "Group by" para identificar IDs duplicados',
                        '<strong>Step 4:</strong> "Calculator" para crear nuevos IDs: MAX_ID + ROW_NUMBER',
                        '<strong>Alternativa:</strong> Usar "Generate random value" para IDs √∫nicos'
                    ],
                    components: ['Sort rows', 'Add sequence', 'Group by', 'Calculator', 'Generate random value'],
                    validation: 'Usar "Group by" con COUNT para verificar que no hay duplicados'
                },
                'calculation_error': {
                    title: 'üîß Soluci√≥n para Error de C√°lculo',
                    steps: [
                        '<strong>Step 1:</strong> "Calculator" para recalcular product_total:',
                        '‚Ä¢ F√≥rmula: product_price * product_quantity',
                        '<strong>Step 2:</strong> "Select values" para reemplazar el campo incorrecto',
                        '<strong>Step 3:</strong> "Number range" para validar que el c√°lculo es l√≥gico',
                        '<strong>Verificaci√≥n:</strong> Comparar total original vs. total calculado'
                    ],
                    components: ['Calculator', 'Select values', 'Number range'],
                    validation: 'Todos los totales deben ser = precio √ó cantidad'
                },
                'unit_mismatch': {
                    title: 'üîß Soluci√≥n para Unidad/Moneda Incorrecta',
                    steps: [
                        '<strong>Step 1:</strong> "Calculator" para detectar precios sin decimales',
                        '<strong>Step 2:</strong> "If field value" para aplicar conversi√≥n:',
                        '‚Ä¢ Si precio > 1000 ‚Üí dividir entre 100 (centavos a pesos)',
                        '‚Ä¢ Si precio es entero ‚Üí agregar .00',
                        '<strong>Step 3:</strong> "Select values" para formatear como decimal(10,2)',
                        '<strong>Step 4:</strong> Recalcular product_total con precios corregidos'
                    ],
                    components: ['Calculator', 'If field value', 'Select values'],
                    validation: 'Verificar que precios est√©n en rango 1.00 - 5,000.00'
                },
                'false_referential_integrity': {
                    title: 'üîß Soluci√≥n para Integridad L√≥gica Falsa',
                    steps: [
                        '<strong>Step 1:</strong> Crear archivo CSV de referencia con valores v√°lidos:',
                        '‚Ä¢ ciudades_estados.csv: ciudad,estado_correcto',
                        '‚Ä¢ departamentos_validos.csv: departamento_valido',
                        '<strong>Step 2:</strong> "Text file input" para cargar archivos de referencia',
                        '<strong>Step 3:</strong> "Stream lookup" para validar contra archivos maestros',
                        '<strong>Step 4:</strong> "Value Mapper" para corregir valores incorrectos:',
                        '‚Ä¢ Mapear ciudades incorrectas en campo pa√≠s ‚Üí usar archivo ciudades_estados.csv',
                        '‚Ä¢ Mapear departamentos v√°lidos: Ventas, Marketing, Sistemas, RRHH, Finanzas',
                        '<strong>Step 5:</strong> "Replace in string" para normalizar nombres'
                    ],
                    components: ['Text file input', 'Stream lookup', 'Value Mapper', 'Replace in string', 'Filter rows'],
                    validation: 'Verificar que cada campo contenga valores de su dominio correcto usando archivos de referencia'
                }
            };
            
            const solution = solutions[errorType];
            if (!solution) return '';
            
            return `
                <div style="margin-bottom: 25px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h5 style="color: #0c4a6e; margin: 0 0 10px 0;">${solution.title}</h5>
                    <div style="margin-bottom: 15px;">
                        <strong>üìã Pasos en Pentaho PDI:</strong>
                        <ol style="margin: 8px 0 0 20px; line-height: 1.6;">
                            ${solution.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>üîß Componentes PDI sugeridos:</strong>
                        <div style="margin-top: 5px;">
                            ${solution.components.map(comp => 
                                `<span style="background: #e0f2fe; color: #01579b; padding: 3px 8px; border-radius: 4px; margin: 2px; display: inline-block; font-size: 0.85rem;">${comp}</span>`
                            ).join('')}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #64748b; font-style: italic;">
                            Se recomienda utilizar los siguientes componentes de PDI. Ten en cuenta que pueden variar seg√∫n la versi√≥n de Pentaho que utilices. No obstante, puedes emplear otros componentes siempre que permitan obtener los mismos resultados.
                        </div>
                    </div>
                    <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; border-left: 3px solid #0284c7;">
                        <strong>‚úÖ Validaci√≥n:</strong> ${solution.validation}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #64748b;">
                        <strong>Registros afectados:</strong> ${errors.length} 
                        (${errors.map(e => `#${e.index + 1}`).slice(0, 5).join(', ')}${errors.length > 5 ? '...' : ''})
                    </div>
                </div>
            `;
            
            // Retornar datos para PDF
            return categoryComparisons;
        }
        
        let errorHighlightEnabled = false;
        
        function toggleErrorHighlight() {
            errorHighlightEnabled = !errorHighlightEnabled;
            const btn = document.getElementById('highlightBtn');
            const errorCells = document.querySelectorAll('.error-cell');
            
            if (errorHighlightEnabled) {
                btn.textContent = 'üîç Ocultar Errores';
                errorCells.forEach(cell => {
                    cell.style.backgroundColor = '#fef2f2';
                    cell.style.borderLeft = '3px solid #ef4444';
                });
            } else {
                btn.textContent = 'üîç Resaltar Errores';
                errorCells.forEach(cell => {
                    cell.style.backgroundColor = '';
                    cell.style.borderLeft = '';
                });
            }
        }
        
        function copyToClipboard() {
            if (!currentDataset) return;
            
            const csvContent = generateCSVContent(currentDataset.data);
            navigator.clipboard.writeText(csvContent).then(() => {
                showStatus('‚úÖ Datos copiados al portapapeles en formato CSV', 'success');
            }).catch(() => {
                showStatus('‚ùå Error al copiar al portapapeles', 'error');
            });
        }
        
        // Funci√≥n universal para descargar archivos
        function downloadFile(blob, fileName, mimeType) {
            const link = document.createElement('a');
            
            if (window.URL && window.URL.createObjectURL) {
                link.href = URL.createObjectURL(blob);
            } else {
                // Fallback para navegadores m√°s antiguos
                const reader = new FileReader();
                reader.onload = function() {
                    link.href = reader.result;
                    link.download = fileName;
                    link.click();
                };
                reader.readAsDataURL(blob);
                return;
            }
            
            link.download = fileName;
            link.style.display = 'none';
            
            // Agregar al DOM, hacer clic y limpiar
            document.body.appendChild(link);
            
            // Forzar el clic
            if (link.click) {
                link.click();
            } else {
                // Fallback para navegadores que no soportan click()
                const event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                link.dispatchEvent(event);
            }
            
            // Limpiar despu√©s de un momento
            setTimeout(() => {
                if (document.body.contains(link)) {
                    document.body.removeChild(link);
                }
                if (window.URL && window.URL.revokeObjectURL && link.href.startsWith('blob:')) {
                    URL.revokeObjectURL(link.href);
                }
            }, 3000);
        }

        function downloadBackupData() {
            if (!currentDataset || !currentDataset.backupData) {
                showStatus('No hay datos de respaldo disponibles', 'error');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const name = document.getElementById('datasetName').value;
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            
            const fileName = `Nombre-_${studentName}_-Grupo-_${studentGroup}_-Tipo-_${name}_datos_respaldo.${format}`;
            
            console.log('Descargando archivo de respaldo:', fileName);
            console.log('Registros de respaldo:', currentDataset.backupData.length);
            
            try {
                let content, mimeType;
                
                if (format === 'csv') {
                    content = generateCSVContent(currentDataset.backupData);
                    content = '\ufeff' + content; // Agregar BOM para UTF-8
                    mimeType = 'text/csv;charset=utf-8;';
                } else {
                    const ws = XLSX.utils.json_to_sheet(currentDataset.backupData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Datos_Respaldo');
                    content = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                }
                
                const blob = new Blob([content], { type: mimeType });
                downloadFile(blob, fileName, mimeType);
                
                showStatus('Descargando ' + fileName + '... (' + currentDataset.backupData.length + ' registros con valores faltantes)', 'success');
                
            } catch (error) {
                console.error('Error en descarga de datos de respaldo:', error);
                showStatus('Error al descargar: ' + error.message, 'error');
            }
        }
        
        function downloadDataset() {
            if (!currentDataset) {
                showStatus('No hay dataset para descargar', 'error');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const name = document.getElementById('datasetName').value;
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            
            // Crear nombre con formato est√°ndar para extracci√≥n de datos (usando guiones bajos como delimitadores)
            const fileName = `Nombre-_${studentName}_-Grupo-_${studentGroup}_-Tipo-_${name}.${format}`;
            
            console.log('Iniciando descarga de archivo:', fileName);
            console.log('Dataset tiene registros:', currentDataset.data.length);
            
            try {
                // Limpiar datos antes de generar archivo (remover campos internos)
                const cleanData = currentDataset.data.map(record => {
                    const cleanRecord = {};
                    Object.keys(record).forEach(key => {
                        // Excluir campos que terminan en '_original', '_calculated', '_correct'
                        if (!key.endsWith('_original') && !key.endsWith('_calculated') && !key.endsWith('_correct')) {
                            cleanRecord[key] = record[key];
                        }
                    });
                    return cleanRecord;
                });
                
                let content, mimeType;
                
                if (format === 'csv') {
                    console.log('Generando CSV...');
                    content = generateCSVContent(cleanData);
                    console.log('CSV generado, longitud:', content.length, 'caracteres');
                    mimeType = 'text/csv;charset=utf-8;';
                    // Agregar BOM para UTF-8
                    content = '\ufeff' + content;
                } else {
                    console.log('Generando Excel...');
                    const ws = XLSX.utils.json_to_sheet(cleanData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Dataset');
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    content = wbout;
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    console.log('Excel generado correctamente');
                }
                
                console.log('Creando blob y enlace de descarga...');
                const blob = new Blob([content], { type: mimeType });
                
                downloadFile(blob, fileName, mimeType);
                
                showStatus('Descargando ' + fileName + '... (' + cleanData.length + ' registros)', 'success');
                
            } catch (error) {
                console.error('Error detallado en descarga:', error);
                showStatus('Error al descargar: ' + error.message, 'error');
            }
        }
        
        function applyError(data, index, errorType) {
            const record = data[index];
            const errorInfo = { index: index, type: errorType, field: '', description: '', solutionHint: '' };
            
            console.log(`Aplicando error ${errorType} en registro ${index}`);
            
            switch (errorType) {
                case ERROR_TYPES.MISSING:
                    const missingField = faker.random.arrayElement(['email', 'phone', 'customer_name', 'city', 'rfc', 'curp']);
                    // Guardar valor original para referencia
                    record[`${missingField}_original`] = record[missingField];
                    record[missingField] = faker.random.boolean() ? null : '';
                    errorInfo.field = missingField;
                    errorInfo.description = `Valor faltante en campo ${missingField}`;
                    errorInfo.solutionHint = `Valor original disponible en ${missingField}_original`;
                    break;
                    
                case ERROR_TYPES.INVALID_FORMAT:
                    const formatErrors = [
                        () => {
                            record.email_original = record.email;
                            record.email = record.email.replace('@', '');
                            errorInfo.field = 'email';
                            errorInfo.description = 'Email con formato inv√°lido (sin @)';
                            errorInfo.solutionHint = 'Email original en email_original, agregar @ antes del dominio';
                        },
                        () => {
                            record.phone_original = record.phone;
                            record.phone = record.phone.replace('+52 ', '').substring(0, 8);
                            errorInfo.field = 'phone';
                            errorInfo.description = 'Tel√©fono mexicano sin c√≥digo de pa√≠s o incompleto';
                            errorInfo.solutionHint = 'Tel√©fono completo con +52 en phone_original';
                        },
                        () => {
                            record.birth_date_original = record.birth_date;
                            record.birth_date = record.birth_date.replace(/-/g, '/').split('/').reverse().join('/');
                            errorInfo.field = 'birth_date';
                            errorInfo.description = 'Fecha con formato DD/MM/YYYY en lugar de YYYY-MM-DD';
                            errorInfo.solutionHint = 'Fecha correcta en birth_date_original';
                        },
                        () => {
                            record.postal_code_original = record.postal_code;
                            record.postal_code = 'CP' + record.postal_code;
                            errorInfo.field = 'postal_code';
                            errorInfo.description = 'C√≥digo postal con prefijo no num√©rico';
                            errorInfo.solutionHint = 'C√≥digo num√©rico en postal_code_original';
                        },
                        () => {
                            record.rfc_original = record.rfc;
                            record.rfc = record.rfc.substring(0, 8); // RFC incompleto
                            errorInfo.field = 'rfc';
                            errorInfo.description = 'RFC mexicano incompleto (debe tener 13 caracteres)';
                            errorInfo.solutionHint = 'RFC completo en rfc_original';
                        },
                        () => {
                            record.curp_original = record.curp;
                            record.curp = record.curp.toLowerCase(); // CURP en min√∫sculas
                            errorInfo.field = 'curp';
                            errorInfo.description = 'CURP en min√∫sculas (debe estar en may√∫sculas)';
                            errorInfo.solutionHint = 'CURP correcto en curp_original';
                        }
                    ];
                    const formatError = faker.random.arrayElement(formatErrors);
                    formatError();
                    break;
                    
                case ERROR_TYPES.OUT_OF_RANGE:
                    const rangeErrors = [
                        () => {
                            record.age_calculated = new Date().getFullYear() - new Date(record.birth_date).getFullYear();
                            record.age = faker.random.number({ min: 150, max: 200 });
                            errorInfo.field = 'age';
                            errorInfo.description = 'Edad fuera de rango l√≥gico (>150 a√±os)';
                            errorInfo.solutionHint = `Edad correcta calculable desde birth_date: ${record.age_calculated} a√±os`;
                        },
                        () => {
                            record.salary_original = record.salary;
                            record.salary = record.salary * 100; // Error de unidad (centavos)
                            errorInfo.field = 'salary';
                            errorInfo.description = 'Salario en centavos en lugar de pesos mexicanos';
                            errorInfo.solutionHint = `Salario correcto en pesos: ${record.salary_original}`;
                        },
                        () => {
                            record.product_price_original = record.product_price;
                            record.product_price = record.product_price * 100;
                            errorInfo.field = 'product_price';
                            errorInfo.description = 'Precio fuera de rango (posible error de unidad)';
                            errorInfo.solutionHint = `Precio correcto en product_price_original: ${record.product_price_original}`;
                        },
                        () => {
                            record.birth_date_calculated = new Date(new Date().getFullYear() - record.age, 0, 1).toISOString().split('T')[0];
                            record.birth_date = '1800-01-01';
                            errorInfo.field = 'birth_date';
                            errorInfo.description = 'Fecha de nacimiento demasiado antigua';
                            errorInfo.solutionHint = `Fecha calculable desde edad: ${record.birth_date_calculated}`;
                        }
                    ];
                    const rangeError = faker.random.arrayElement(rangeErrors);
                    rangeError();
                    break;
                    
                case ERROR_TYPES.DUPLICATE:
                    record.id_original = record.id;
                    if (index > 0) {
                        record.id = data[index - 1].id;
                        errorInfo.description = `ID duplicado (${record.id})`;
                    } else {
                        record.id = 999999;
                        errorInfo.description = 'ID duplicado (999999)';
                    }
                    errorInfo.field = 'id';
                    errorInfo.solutionHint = `ID original √∫nico en id_original: ${record.id_original}`;
                    break;
                    
                case ERROR_TYPES.CALCULATION_ERROR:
                    const correctTotal = record.product_price * record.product_quantity;
                    record.product_total_correct = correctTotal;
                    const errorFactor = faker.random.arrayElement([0.5, 1.5, 2, 0.1]);
                    record.product_total = Math.round(correctTotal * errorFactor);
                    errorInfo.field = 'product_total';
                    errorInfo.description = `Error de c√°lculo: total deber√≠a ser ${correctTotal} pero es ${record.product_total}`;
                    errorInfo.solutionHint = `Total correcto en product_total_correct: ${correctTotal}`;
                    break;
                    
                case ERROR_TYPES.UNIT_MISMATCH:
                    record.product_price_original = record.product_price;
                    record.product_price = Math.round(record.product_price * 100);
                    errorInfo.field = 'product_price';
                    errorInfo.description = 'Posible error de unidad/moneda (precio en centavos)';
                    errorInfo.solutionHint = `Precio en unidad correcta en product_price_original: ${record.product_price_original}`;
                    break;
                    
                case ERROR_TYPES.FALSE_REFERENTIAL_INTEGRITY:
                    const integrityErrors = [
                        () => {
                            record.state_original = record.state;
                            record.state = record.city;
                            errorInfo.field = 'state';
                            errorInfo.description = 'Integridad l√≥gica falsa: ciudad en campo estado';
                            errorInfo.solutionHint = `Estado correcto en state_original: ${record.state_original}`;
                        },
                        () => {
                            record.department_original = record.department;
                            record.department = record.city;
                            errorInfo.field = 'department';
                            errorInfo.description = 'Integridad l√≥gica falsa: ciudad en campo departamento';
                            errorInfo.solutionHint = `Departamento correcto en department_original: ${record.department_original}`;
                        },
                        () => {
                            record.city_original = record.city;
                            record.city = record.department;
                            errorInfo.field = 'city';
                            errorInfo.description = 'Integridad l√≥gica falsa: departamento en campo ciudad';
                            errorInfo.solutionHint = `Ciudad correcta en city_original: ${record.city_original}`;
                        },
                        () => {
                            record.country_original = record.country;
                            record.country = record.state;
                            errorInfo.field = 'country';
                            errorInfo.description = 'Integridad l√≥gica falsa: estado en campo pa√≠s';
                            errorInfo.solutionHint = `Pa√≠s correcto en country_original: ${record.country_original}`;
                        }
                    ];
                    const integrityError = faker.random.arrayElement(integrityErrors);
                    integrityError();
                    break;
            }
            
            originalErrors.push(errorInfo);
            console.log(`Error aplicado: ${errorInfo.description}`);
        }
        

        
        // Configurar zona de arrastre para validador individual
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Configurar zonas de arrastre para comparador
        setupComparisonDropZones();
        
        function handleFileUpload(file) {
            showStatus('Procesando archivo para validaci√≥n...', 'success');
            
            // Extraer informaci√≥n del estudiante del nombre del archivo
            const studentInfo = extractStudentInfoFromFilename(file.name);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let correctedData;
                    
                    if (file.name.endsWith('.csv')) {
                        correctedData = parseCSV(e.target.result);
                    } else if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        correctedData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    } else {
                        throw new Error('Formato de archivo no soportado');
                    }
                    
                    validateUniversalData(correctedData, studentInfo);
                } catch (error) {
                    showStatus(`Error al procesar archivo: ${error.message}`, 'error');
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || null;
                });
                return obj;
            });
        }
        
        function validateUniversalData(data, studentInfo = null) {
            console.log('Iniciando validaci√≥n universal de datos...');
            
            const validationResults = {
                score: 0,
                totalRecords: data.length,
                recordsWithErrors: 0,
                recordsWithoutErrors: 0,
                totalChecks: 0,
                passedChecks: 0,
                errors: [],
                warnings: [],
                summary: {},
                studentInfo: studentInfo
            };
            
            // Validaciones universales para datos mexicanos
            const validations = [
                // 1. Validaciones de formato
                {
                    name: 'Formato de Email',
                    check: (record, index) => {
                        if (!record.email) return { valid: false, message: 'Email faltante' };
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return {
                            valid: emailRegex.test(record.email),
                            message: emailRegex.test(record.email) ? 'Email v√°lido' : 'Formato de email inv√°lido'
                        };
                    }
                },
                {
                    name: 'Tel√©fono Mexicano',
                    check: (record, index) => {
                        if (!record.phone) return { valid: false, message: 'Tel√©fono faltante' };
                        const hasCountryCode = record.phone.includes('+52');
                        const hasMinLength = record.phone.replace(/\s|-/g, '').length >= 12;
                        return {
                            valid: hasCountryCode && hasMinLength,
                            message: hasCountryCode && hasMinLength ? 'Tel√©fono v√°lido' : 'Tel√©fono debe incluir +52 y tener formato completo'
                        };
                    }
                },
                {
                    name: 'RFC Mexicano',
                    check: (record, index) => {
                        if (!record.rfc) return { valid: false, message: 'RFC faltante' };
                        
                        // Validar longitud (13 caracteres para personas f√≠sicas)
                        if (record.rfc.length !== 13) {
                            return { valid: false, message: `RFC debe tener 13 caracteres, tiene ${record.rfc.length}` };
                        }
                        
                        // Validar que est√© en may√∫sculas
                        if (record.rfc !== record.rfc.toUpperCase()) {
                            return { valid: false, message: 'RFC debe estar en may√∫sculas' };
                        }
                        
                        // Validar patr√≥n: 4 letras + 6 d√≠gitos (AAMMDD) + 3 caracteres alfanum√©ricos
                        const rfcPattern = /^[A-Z]{4}[0-9]{6}[A-Z0-9]{3}$/;
                        if (!rfcPattern.test(record.rfc)) {
                            return { valid: false, message: 'RFC con formato inv√°lido (debe ser: 4 letras + AAMMDD + 3 alfanum√©ricos)' };
                        }
                        
                        // Validar fecha dentro del RFC (posiciones 4-9: AAMMDD)
                        const year = parseInt(record.rfc.substring(4, 6));
                        const month = parseInt(record.rfc.substring(6, 8));
                        const day = parseInt(record.rfc.substring(8, 10));
                        
                        // Determinar siglo (00-29 = 2000s, 30-99 = 1900s)
                        const fullYear = year <= 29 ? 2000 + year : 1900 + year;
                        
                        // Validar que la fecha sea v√°lida
                        const dateValid = month >= 1 && month <= 12 && day >= 1 && day <= 31;
                        const currentYear = new Date().getFullYear();
                        const yearValid = fullYear >= 1900 && fullYear <= currentYear;
                        
                        if (!dateValid || !yearValid) {
                            return { valid: false, message: `RFC con fecha inv√°lida: ${day}/${month}/${fullYear}` };
                        }
                        
                        return { valid: true, message: 'RFC v√°lido' };
                    }
                },
                {
                    name: 'CURP Mexicano',
                    check: (record, index) => {
                        if (!record.curp) return { valid: false, message: 'CURP faltante' };
                        
                        // Patr√≥n CURP: 4 letras + 6 d√≠gitos (AAMMDD) + 1 letra (H/M) + 2 letras (estado) + 3 consonantes + 1 d√≠gito verificador + 1 d√≠gito
                        const curpPattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{2}[BCDFGHJKLMNPQRSTVWXYZ]{3}[0-9A-Z][0-9]$/;
                        const isValidFormat = curpPattern.test(record.curp);
                        
                        if (!isValidFormat) {
                            return {
                                valid: false,
                                message: 'CURP con formato inv√°lido (debe ser: 4 letras + AAMMDD + H/M + estado + consonantes + verificadores)'
                            };
                        }
                        
                        // Validar fecha dentro del CURP (posiciones 4-9: AAMMDD)
                        const year = parseInt(record.curp.substring(4, 6));
                        const month = parseInt(record.curp.substring(6, 8));
                        const day = parseInt(record.curp.substring(8, 10));
                        
                        // Determinar siglo (00-29 = 2000s, 30-99 = 1900s)
                        const fullYear = year <= 29 ? 2000 + year : 1900 + year;
                        
                        // Validar que la fecha sea v√°lida
                        const dateValid = month >= 1 && month <= 12 && day >= 1 && day <= 31;
                        const currentYear = new Date().getFullYear();
                        const yearValid = fullYear >= 1900 && fullYear <= currentYear;
                        
                        return {
                            valid: dateValid && yearValid,
                            message: dateValid && yearValid ? 'CURP v√°lido' : `CURP con fecha inv√°lida: ${day}/${month}/${fullYear}`
                        };
                    }
                },
                {
                    name: 'C√≥digo Postal',
                    check: (record, index) => {
                        if (!record.postal_code) return { valid: false, message: 'C√≥digo postal faltante' };
                        const isNumeric = /^\d{5}$/.test(record.postal_code);
                        return {
                            valid: isNumeric,
                            message: isNumeric ? 'C√≥digo postal v√°lido' : 'C√≥digo postal debe ser 5 d√≠gitos num√©ricos'
                        };
                    }
                },
                
                // 2. Validaciones de rango
                {
                    name: 'Edad V√°lida',
                    check: (record, index) => {
                        if (!record.age) return { valid: false, message: 'Edad faltante' };
                        const age = parseInt(record.age);
                        const validRange = age >= 18 && age <= 100;
                        return {
                            valid: validRange,
                            message: validRange ? 'Edad v√°lida' : `Edad fuera de rango (18-100): ${age}`
                        };
                    }
                },
                {
                    name: 'Salario Mexicano',
                    check: (record, index) => {
                        if (!record.salary) return { valid: false, message: 'Salario faltante' };
                        const salary = parseFloat(record.salary);
                        const validRange = salary >= 5000 && salary <= 200000; // Pesos mexicanos
                        return {
                            valid: validRange,
                            message: validRange ? 'Salario v√°lido' : `Salario fuera de rango (5,000-200,000 MXN): ${salary}`
                        };
                    }
                },
                {
                    name: 'Precio de Producto',
                    check: (record, index) => {
                        if (!record.product_price) return { valid: false, message: 'Precio faltante' };
                        const price = parseFloat(record.product_price);
                        const validRange = price >= 1 && price <= 10000;
                        return {
                            valid: validRange,
                            message: validRange ? 'Precio v√°lido' : `Precio fuera de rango (1-10,000 MXN): ${price}`
                        };
                    }
                },
                
                // 3. Validaciones de integridad
                {
                    name: 'Pa√≠s M√©xico',
                    check: (record, index) => {
                        if (!record.country) return { valid: false, message: 'Pa√≠s faltante' };
                        const isMexico = record.country.toLowerCase().includes('m√©xico') || record.country.toLowerCase().includes('mexico');
                        return {
                            valid: isMexico,
                            message: isMexico ? 'Pa√≠s correcto' : `Pa√≠s debe ser M√©xico: ${record.country}`
                        };
                    }
                },
                {
                    name: 'Estado Mexicano V√°lido',
                    check: (record, index) => {
                        if (!record.state) return { valid: false, message: 'Estado faltante' };
                        const validStates = ['CDMX', 'Jalisco', 'Nuevo Le√≥n', 'Puebla', 'Baja California', 'Guanajuato', 'Chihuahua', 'Coahuila', 'Quer√©taro', 'San Luis Potos√≠', 'Yucat√°n', 'Baja California Sur', 'Aguascalientes', 'Morelos', 'Sonora', 'Sinaloa', 'Durango', 'Estado de M√©xico', 'Tamaulipas'];
                        const isValid = validStates.includes(record.state);
                        return {
                            valid: isValid,
                            message: isValid ? 'Estado v√°lido' : `Estado no reconocido: ${record.state}`
                        };
                    }
                },
                {
                    name: 'Ciudad Mexicana V√°lida',
                    check: (record, index) => {
                        if (!record.city) return { valid: false, message: 'Ciudad faltante' };
                        const validCities = ['Ciudad de M√©xico', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 'Le√≥n', 'Ju√°rez', 'Torre√≥n', 'Quer√©taro', 'San Luis Potos√≠', 'M√©rida', 'Mexicali', 'Aguascalientes', 'Cuernavaca', 'Saltillo', 'Hermosillo', 'Culiac√°n', 'Durango', 'Toluca', 'Tampico'];
                        const isValid = validCities.includes(record.city);
                        return {
                            valid: isValid,
                            message: isValid ? 'Ciudad v√°lida' : `Ciudad no reconocida: ${record.city}`
                        };
                    }
                },
                {
                    name: 'Departamento V√°lido',
                    check: (record, index) => {
                        if (!record.department) return { valid: false, message: 'Departamento faltante' };
                        const validDepts = ['Ventas', 'Marketing', 'Sistemas', 'Recursos Humanos', 'Finanzas', 'Operaciones'];
                        const isValid = validDepts.includes(record.department);
                        return {
                            valid: isValid,
                            message: isValid ? 'Departamento v√°lido' : `Departamento no v√°lido: ${record.department}`
                        };
                    }
                },
                
                // 4. Validaciones de c√°lculo
                {
                    name: 'C√°lculo de Total',
                    check: (record, index) => {
                        if (!record.product_price || !record.product_quantity || !record.product_total) {
                            return { valid: false, message: 'Datos de producto incompletos' };
                        }
                        const expectedTotal = parseFloat(record.product_price) * parseInt(record.product_quantity);
                        const actualTotal = parseFloat(record.product_total);
                        const isCorrect = Math.abs(expectedTotal - actualTotal) < 0.01;
                        return {
                            valid: isCorrect,
                            message: isCorrect ? 'C√°lculo correcto' : `Total incorrecto: esperado ${expectedTotal}, actual ${actualTotal}`
                        };
                    }
                },
                
                // 5. Validaciones de fecha
                {
                    name: 'Fecha de Nacimiento',
                    check: (record, index) => {
                        if (!record.birth_date) return { valid: false, message: 'Fecha de nacimiento faltante' };
                        const date = new Date(record.birth_date);
                        const isValidDate = date instanceof Date && !isNaN(date);
                        const currentYear = new Date().getFullYear();
                        const birthYear = date.getFullYear();
                        const reasonableRange = birthYear >= 1920 && birthYear <= currentYear - 18;
                        return {
                            valid: isValidDate && reasonableRange,
                            message: isValidDate && reasonableRange ? 'Fecha v√°lida' : 'Fecha de nacimiento inv√°lida o fuera de rango'
                        };
                    }
                },
                
                // 6. Validaci√≥n de duplicados
                {
                    name: 'ID √önico',
                    check: (record, index) => {
                        if (!record.id) return { valid: false, message: 'ID faltante' };
                        const duplicateCount = data.filter(r => r.id === record.id).length;
                        return {
                            valid: duplicateCount === 1,
                            message: duplicateCount === 1 ? 'ID √∫nico' : `ID duplicado: ${record.id} (aparece ${duplicateCount} veces)`
                        };
                    }
                }
            ];
            
            // Ejecutar todas las validaciones y rastrear registros con errores
            const recordsWithErrorsSet = new Set();
            
            data.forEach((record, index) => {
                let recordHasError = false;
                
                validations.forEach(validation => {
                    validationResults.totalChecks++;
                    const result = validation.check(record, index);
                    
                    if (result.valid) {
                        validationResults.passedChecks++;
                    } else {
                        recordHasError = true;
                        recordsWithErrorsSet.add(index);
                        validationResults.errors.push({
                            record: index + 1,
                            field: validation.name,
                            message: result.message,
                            severity: 'error'
                        });
                    }
                });
            });
            
            // Calcular m√©tricas de calidad basadas en registros
            validationResults.recordsWithErrors = recordsWithErrorsSet.size;
            validationResults.recordsWithoutErrors = validationResults.totalRecords - validationResults.recordsWithErrors;
            
            // Calcular puntuaci√≥n de calidad: % de registros sin errores
            validationResults.score = Math.round((validationResults.recordsWithoutErrors / validationResults.totalRecords) * 100);
            
            // Generar resumen por categor√≠a
            const errorsByCategory = {};
            validationResults.errors.forEach(error => {
                const category = error.field;
                if (!errorsByCategory[category]) {
                    errorsByCategory[category] = 0;
                }
                errorsByCategory[category]++;
            });
            
            validationResults.summary = {
                totalRecords: validationResults.totalRecords,
                recordsWithErrors: validationResults.recordsWithErrors,
                recordsWithoutErrors: validationResults.recordsWithoutErrors,
                totalChecks: validationResults.totalChecks,
                passedChecks: validationResults.passedChecks,
                failedChecks: validationResults.totalChecks - validationResults.passedChecks,
                errorsByCategory: errorsByCategory
            };
            
            console.log('Validaci√≥n completada:', validationResults);
            
            // Guardar resultados para generar PDF
            lastValidationResults = validationResults;
            
            displayUniversalValidationResults(validationResults);
            
            // Habilitar bot√≥n de PDF despu√©s de validaci√≥n exitosa
            const validationPDFBtn = document.getElementById('validationPDFBtn');
            if (validationPDFBtn) {
                validationPDFBtn.disabled = false;
                validationPDFBtn.style.opacity = '1';
            }
        }
        
        function isValidDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
        }
        
        function displayUniversalValidationResults(results) {
            const resultsDiv = document.getElementById('validationResults');
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            const scoreLabel = document.getElementById('scoreLabel');
            const errorReport = document.getElementById('errorReport');
            
            console.log('=== MOSTRANDO RESULTADOS DE VALIDACI√ìN ===');
            console.log('Informaci√≥n del estudiante recibida:', results.studentInfo);
            
            // Mostrar puntuaci√≥n
            scoreText.textContent = `${results.score}%`;
            
            // Colorear c√≠rculo seg√∫n puntuaci√≥n
            if (results.score >= 98) {
                scoreCircle.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                scoreLabel.textContent = `¬°Excelente! ${results.summary.recordsWithoutErrors} de ${results.summary.totalRecords} registros sin errores`;
            } else if (results.score >= 89) {
                scoreCircle.style.background = 'linear-gradient(135deg, #38a169, #2f855a)';
                scoreLabel.textContent = `Aceptable: ${results.summary.recordsWithoutErrors} de ${results.summary.totalRecords} registros correctos`;
            } else if (results.score >= 85) {
                scoreCircle.style.background = 'linear-gradient(135deg, #ed8936, #dd6b20)';
                scoreLabel.textContent = `Satisfactorio: ${results.summary.recordsWithErrors} de ${results.summary.totalRecords} registros con errores`;
            } else {
                scoreCircle.style.background = 'linear-gradient(135deg, #e53e3e, #c53030)';
                scoreLabel.textContent = `No Aceptable: ${results.summary.recordsWithErrors} de ${results.summary.totalRecords} registros con errores`;
            }
            
            // Generar reporte detallado
            const categoryStats = Object.keys(results.summary.errorsByCategory).map(category => {
                const errorCount = results.summary.errorsByCategory[category];
                const totalForCategory = results.summary.totalRecords; // Cada registro se valida para cada categor√≠a
                const successRate = Math.round(((totalForCategory - errorCount) / totalForCategory) * 100);
                return { category, errorCount, successRate };
            }).sort((a, b) => b.errorCount - a.errorCount);
            
            // SIEMPRE mostrar informaci√≥n del estudiante, incluso si no se pudo extraer completamente
            const studentInfoHTML = results.studentInfo ? `
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 3px solid #047857;">
                    <h3 style="color: white; margin: 0 0 20px 0; font-size: 1.5rem;">üìã INFORMACI√ìN DEL ESTUDIANTE - EVIDENCIA DE EVALUACI√ìN</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #f0fdf4;">üë§ Estudiante</div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${results.studentInfo.studentName}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #f0fdf4;">üéì Grupo</div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${results.studentInfo.studentGroup}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #f0fdf4;">üìÑ Archivo</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">${results.studentInfo.fileType}</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 1rem; opacity: 0.9;">
                            <strong>üìÅ Archivo completo:</strong> ${results.studentInfo.fileName}<br>
                            <strong>üïí Fecha de evaluaci√≥n:</strong> ${new Date().toLocaleString('es-MX')}<br>
                            ${results.studentInfo.extractionMethod ? `<strong>üîç M√©todo de extracci√≥n:</strong> ${results.studentInfo.extractionMethod}<br>` : ''}
                            <strong>‚úÖ Estado:</strong> ${results.studentInfo.hasInfo ? 'Informaci√≥n extra√≠da correctamente' : 'Informaci√≥n parcial extra√≠da'}
                        </div>
                    </div>
                </div>
            ` : `
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 3px solid #b45309;">
                    <h3 style="color: white; margin: 0 0 15px 0;">‚ö†Ô∏è INFORMACI√ìN DEL ESTUDIANTE NO DISPONIBLE</h3>
                    <p style="margin: 0; font-size: 1.1rem;">No se pudo extraer la informaci√≥n del estudiante del nombre del archivo. Para futuras evaluaciones, usa el formato: Nombre-"Tu Nombre"-Grupo-"Tu Grupo"-Tipo-"dataset_evaluacion"</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>üïí Fecha de evaluaci√≥n:</strong> ${new Date().toLocaleString('es-MX')}
                    </div>
                </div>
            `;
            
            console.log('‚úÖ Mostrando informaci√≥n del estudiante en validador individual');
            
            errorReport.innerHTML = studentInfoHTML + `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #1a202c; margin: 0 0 15px 0;">üìä Resumen General de Validaci√≥n</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${results.summary.totalRecords}</div>
                            <div style="color: #64748b;">Registros Analizados</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;">${results.summary.recordsWithoutErrors}</div>
                            <div style="color: #64748b;">Registros Sin Errores</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${results.summary.recordsWithErrors}</div>
                            <div style="color: #64748b;">Registros Con Errores</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #7c3aed;">${results.score}%</div>
                            <div style="color: #64748b;">Calidad de Datos</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                        <h5 style="color: #374151; margin: 0 0 10px 0;">üéØ C√°lculo de Calidad</h5>
                        <p style="color: #64748b; margin: 0; line-height: 1.6;">
                            <strong>Calidad = (Registros sin errores √∑ Total de registros) √ó 100</strong><br>
                            Calidad = (${results.summary.recordsWithoutErrors} √∑ ${results.summary.totalRecords}) √ó 100 = <strong>${results.score}%</strong>
                        </p>
                    </div>
                </div>
                
                ${categoryStats.length > 0 ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: #1a202c; margin: 0 0 15px 0;">üìà Calidad por Categor√≠a</h4>
                        ${categoryStats.map(stat => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                                <div>
                                    <strong>${stat.category}</strong>
                                    <div style="font-size: 0.9rem; color: #64748b;">${stat.errorCount} errores encontrados</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: ${stat.successRate >= 80 ? '#059669' : stat.successRate >= 60 ? '#d97706' : '#dc2626'};">
                                        ${stat.successRate}%
                                    </div>
                                    <div style="font-size: 0.8rem; color: #64748b;">√©xito</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${results.errors.length > 0 ? `
                    <div style="background: #fef2f2; padding: 20px; border-radius: 12px; border: 1px solid #fecaca;">
                        <h4 style="color: #991b1b; margin: 0 0 15px 0;">üö® Errores Detallados (Mostrando primeros 20)</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${results.errors.slice(0, 20).map(error => `
                                <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #ef4444;">
                                    <div style="font-weight: 600; color: #991b1b;">
                                        üìç Registro ${error.record} - ${error.field}
                                    </div>
                                    <div style="color: #7f1d1d; margin-top: 4px;">
                                        ${error.message}
                                    </div>
                                </div>
                            `).join('')}
                            ${results.errors.length > 20 ? `
                                <div style="text-align: center; padding: 15px; color: #64748b; font-style: italic;">
                                    ... y ${results.errors.length - 20} errores m√°s
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : `
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 1px solid #bbf7d0; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üéâ</div>
                        <h4 style="color: #166534; margin: 0 0 10px 0;">¬°Perfecto!</h4>
                        <p style="color: #15803d; margin: 0;">Todos los datos han pasado las validaciones de calidad.</p>
                    </div>
                `}
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 2px solid #0ea5e9; margin-top: 20px;">
                    <h4 style="color: #0c4a6e; margin: 0 0 15px 0;">üí° Recomendaciones para Pentaho PDI</h4>
                    <div style="line-height: 1.6; color: #0369a1;">
                        ${results.score >= 98 ? 
                            '‚Ä¢ <strong>Excelente:</strong> Los datos est√°n listos para producci√≥n<br>‚Ä¢ Considera implementar monitoreo continuo de calidad<br>‚Ä¢ Documenta las reglas de validaci√≥n aplicadas' :
                        results.score >= 89 ?
                            '‚Ä¢ <strong>Aceptable:</strong> Corrige los errores menores restantes<br>‚Ä¢ Implementa validaciones autom√°ticas en el pipeline ETL<br>‚Ä¢ Revisa los casos edge identificados' :
                        results.score >= 85 ?
                            '‚Ä¢ <strong>Satisfactorio:</strong> Enf√≥cate en las categor√≠as con m√°s errores<br>‚Ä¢ Usa componentes de limpieza espec√≠ficos en PDI<br>‚Ä¢ Implementa reglas de negocio m√°s estrictas' :
                            '‚Ä¢ <strong>No Aceptable:</strong> Los datos requieren limpieza significativa<br>‚Ä¢ Revisa los procesos de captura de datos<br>‚Ä¢ Implementa validaciones en tiempo real<br>‚Ä¢ Considera reestructuraci√≥n completa del dataset'
                        }
                    </div>
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
            showStatus(`‚úÖ Validaci√≥n completada. Calidad: ${results.score}% (${results.summary.recordsWithoutErrors} de ${results.summary.totalRecords} registros sin errores)`, 'success');
        }
        
        function showProgress(show) {
            const progressBar = document.getElementById('progressBar');
            if (show) {
                progressBar.classList.remove('hidden');
                updateProgress(0);
            } else {
                progressBar.classList.add('hidden');
            }
        }
        
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('generationStatus');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        // Funciones del Comparador de Mejoras ETL
        function setupComparisonDropZones() {
            // Configurar zona de archivo original
            const originalDropZone = document.getElementById('originalDropZone');
            const originalFileInput = document.getElementById('originalFileInput');
            
            originalDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                originalDropZone.classList.add('dragover');
            });
            
            originalDropZone.addEventListener('dragleave', () => {
                originalDropZone.classList.remove('dragover');
            });
            
            originalDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                originalDropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleOriginalFileUpload(files[0]);
                }
            });
            
            originalFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleOriginalFileUpload(e.target.files[0]);
                }
            });

            // Configurar zona de archivo procesado
            const processedDropZone = document.getElementById('processedDropZone');
            const processedFileInput = document.getElementById('processedFileInput');
            
            processedDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                processedDropZone.classList.add('dragover');
            });
            
            processedDropZone.addEventListener('dragleave', () => {
                processedDropZone.classList.remove('dragover');
            });
            
            processedDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                processedDropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleProcessedFileUpload(files[0]);
                }
            });
            
            processedFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleProcessedFileUpload(e.target.files[0]);
                }
            });
        }

        function handleOriginalFileUpload(file) {
            document.getElementById('originalStatus').innerHTML = '‚è≥ Procesando archivo original...';
            
            // Extraer informaci√≥n del estudiante del nombre del archivo
            const studentInfo = extractStudentInfoFromFilename(file.name);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let data;
                    
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    } else {
                        throw new Error('Formato de archivo no soportado');
                    }
                    
                    originalDataset = {
                        data: data,
                        fileName: file.name,
                        validation: validateDataset(data),
                        studentInfo: studentInfo
                    };
                    
                    document.getElementById('originalStatus').innerHTML = `‚úÖ ${file.name} cargado (${data.length} registros, ${originalDataset.validation.score}% calidad)`;
                    checkComparisonReady();
                    
                } catch (error) {
                    document.getElementById('originalStatus').innerHTML = `‚ùå Error: ${error.message}`;
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function handleProcessedFileUpload(file) {
            document.getElementById('processedStatus').innerHTML = '‚è≥ Procesando archivo procesado...';
            
            // Extraer informaci√≥n del estudiante del nombre del archivo
            const studentInfo = extractStudentInfoFromFilename(file.name);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let data;
                    
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    } else {
                        throw new Error('Formato de archivo no soportado');
                    }
                    
                    processedDataset = {
                        data: data,
                        fileName: file.name,
                        validation: validateDataset(data),
                        studentInfo: studentInfo
                    };
                    
                    document.getElementById('processedStatus').innerHTML = `‚úÖ ${file.name} cargado (${data.length} registros, ${processedDataset.validation.score}% calidad)`;
                    checkComparisonReady();
                    
                } catch (error) {
                    document.getElementById('processedStatus').innerHTML = `‚ùå Error: ${error.message}`;
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function checkComparisonReady() {
            const compareBtn = document.getElementById('compareBtn');
            const comparePDFBtn = document.getElementById('comparePDFBtn');
            if (originalDataset && processedDataset) {
                compareBtn.disabled = false;
                compareBtn.style.opacity = '1';
                comparePDFBtn.disabled = false;
                comparePDFBtn.style.opacity = '1';
            }
        }

        function validateDataset(data) {
            const validationResults = {
                score: 0,
                totalChecks: 0,
                passedChecks: 0,
                errors: [],
                summary: {}
            };
            
            // Usar las mismas validaciones que validateUniversalData pero simplificado
            const validations = [
                {
                    name: 'Formato de Email',
                    check: (record) => {
                        if (!record.email) return false;
                        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(record.email);
                    }
                },
                {
                    name: 'Tel√©fono Mexicano',
                    check: (record) => {
                        if (!record.phone) return false;
                        return record.phone.includes('+52') && record.phone.replace(/\s|-/g, '').length >= 12;
                    }
                },
                {
                    name: 'RFC Mexicano',
                    check: (record) => {
                        if (!record.rfc) return false;
                        
                        // Validar longitud y formato b√°sico
                        if (record.rfc.length !== 13 || record.rfc !== record.rfc.toUpperCase()) {
                            return false;
                        }
                        
                        // Validar patr√≥n: 4 letras + 6 d√≠gitos + 3 alfanum√©ricos
                        const rfcPattern = /^[A-Z]{4}[0-9]{6}[A-Z0-9]{3}$/;
                        if (!rfcPattern.test(record.rfc)) {
                            return false;
                        }
                        
                        // Validar fecha dentro del RFC
                        const year = parseInt(record.rfc.substring(4, 6));
                        const month = parseInt(record.rfc.substring(6, 8));
                        const day = parseInt(record.rfc.substring(8, 10));
                        
                        const fullYear = year <= 29 ? 2000 + year : 1900 + year;
                        const dateValid = month >= 1 && month <= 12 && day >= 1 && day <= 31;
                        const yearValid = fullYear >= 1900 && fullYear <= new Date().getFullYear();
                        
                        return dateValid && yearValid;
                    }
                },
                {
                    name: 'CURP Mexicano',
                    check: (record) => {
                        if (!record.curp) return false;
                        
                        // Patr√≥n CURP completo seg√∫n normatividad mexicana
                        const curpPattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{2}[BCDFGHJKLMNPQRSTVWXYZ]{3}[0-9A-Z][0-9]$/;
                        if (!curpPattern.test(record.curp)) return false;
                        
                        // Validar fecha dentro del CURP
                        const year = parseInt(record.curp.substring(4, 6));
                        const month = parseInt(record.curp.substring(6, 8));
                        const day = parseInt(record.curp.substring(8, 10));
                        
                        const fullYear = year <= 29 ? 2000 + year : 1900 + year;
                        const dateValid = month >= 1 && month <= 12 && day >= 1 && day <= 31;
                        const yearValid = fullYear >= 1900 && fullYear <= new Date().getFullYear();
                        
                        return dateValid && yearValid;
                    }
                },
                {
                    name: 'C√≥digo Postal',
                    check: (record) => {
                        if (!record.postal_code) return false;
                        return /^\d{5}$/.test(record.postal_code);
                    }
                },
                {
                    name: 'Edad V√°lida',
                    check: (record) => {
                        if (!record.age) return false;
                        const age = parseInt(record.age);
                        return age >= 18 && age <= 100;
                    }
                },
                {
                    name: 'Salario Mexicano',
                    check: (record) => {
                        if (!record.salary) return false;
                        const salary = parseFloat(record.salary);
                        return salary >= 5000 && salary <= 200000;
                    }
                },
                {
                    name: 'Precio de Producto',
                    check: (record) => {
                        if (!record.product_price) return false;
                        const price = parseFloat(record.product_price);
                        return price >= 1 && price <= 10000;
                    }
                },
                {
                    name: 'Pa√≠s M√©xico',
                    check: (record) => {
                        if (!record.country) return false;
                        return record.country.toLowerCase().includes('m√©xico') || record.country.toLowerCase().includes('mexico');
                    }
                },
                {
                    name: 'C√°lculo de Total',
                    check: (record) => {
                        if (!record.product_price || !record.product_quantity || !record.product_total) return false;
                        const expected = parseFloat(record.product_price) * parseInt(record.product_quantity);
                        const actual = parseFloat(record.product_total);
                        return Math.abs(expected - actual) < 0.01;
                    }
                },
                {
                    name: 'ID √önico',
                    check: (record, index, allData) => {
                        if (!record.id) return false;
                        return allData.filter(r => r.id === record.id).length === 1;
                    }
                }
            ];
            
            // Ejecutar validaciones
            data.forEach((record, index) => {
                validations.forEach(validation => {
                    validationResults.totalChecks++;
                    const isValid = validation.check(record, index, data);
                    
                    if (isValid) {
                        validationResults.passedChecks++;
                    } else {
                        validationResults.errors.push({
                            record: index + 1,
                            field: validation.name,
                            message: `Error en ${validation.name}`
                        });
                    }
                });
            });
            
            validationResults.score = Math.round((validationResults.passedChecks / validationResults.totalChecks) * 100);
            
            return validationResults;
        }

        function compareDatasets() {
            if (!originalDataset || !processedDataset) {
                alert('Por favor carga ambos archivos antes de comparar');
                return;
            }
            
            // Validar que ambos archivos tengan el mismo n√∫mero de registros
            if (originalDataset.data.length !== processedDataset.data.length) {
                alert(`‚ö†Ô∏è Advertencia: Los archivos tienen diferente n√∫mero de registros.\nOriginal: ${originalDataset.data.length} registros\nProcesado: ${processedDataset.data.length} registros\n\nLa comparaci√≥n puede no ser precisa.`);
            }
            
            const originalScore = originalDataset.validation.score;
            const processedScore = processedDataset.validation.score;
            const originalErrors = originalDataset.validation.errors.length;
            const processedErrors = processedDataset.validation.errors.length;
            const errorsCorrected = originalErrors - processedErrors;
            
            // Calcular mejora proporcional: (errores corregidos / errores originales) * 100
            let improvementPercentage = 0;
            if (originalErrors > 0) {
                improvementPercentage = (errorsCorrected / originalErrors) * 100;
            }
            
            // Redondear a 1 decimal
            improvementPercentage = Math.round(improvementPercentage * 10) / 10;
            
            // SIEMPRE mostrar informaci√≥n del estudiante, incluso si es parcial
            const studentInfoToShow = originalDataset.studentInfo || processedDataset.studentInfo;
            console.log('=== INFORMACI√ìN DEL ESTUDIANTE EN COMPARADOR ===');
            console.log('Original dataset studentInfo:', originalDataset.studentInfo);
            console.log('Processed dataset studentInfo:', processedDataset.studentInfo);
            console.log('Informaci√≥n seleccionada para mostrar:', studentInfoToShow);
            
            // Crear HTML de informaci√≥n del estudiante (SIEMPRE se muestra)
            const studentInfoHTML = studentInfoToShow ? `
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 3px solid #1e40af;">
                    <h3 style="color: white; margin: 0 0 20px 0; font-size: 1.6rem;">üìä COMPARACI√ìN ETL - EVIDENCIA DE EVALUACI√ìN</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #dbeafe;">üë§ Estudiante</div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${studentInfoToShow.studentName}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #dbeafe;">üéì Grupo</div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${studentInfoToShow.studentGroup}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; color: #dbeafe;">üìÅ Archivos</div>
                            <div style="font-size: 1rem; font-weight: 600;">
                                Original: ${originalDataset.studentInfo?.fileType || originalDataset.fileName || 'Archivo original'}<br>
                                Procesado: ${processedDataset.studentInfo?.fileType || processedDataset.fileName || 'Archivo procesado'}
                            </div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 1rem; opacity: 0.9;">
                            <strong>üìÅ Archivos comparados:</strong><br>
                            ‚Ä¢ Original: ${originalDataset.fileName}<br>
                            ‚Ä¢ Procesado: ${processedDataset.fileName}<br>
                            <strong>üïí Fecha de comparaci√≥n:</strong> ${new Date().toLocaleString('es-MX')}<br>
                            <strong>‚úÖ Estado:</strong> ${studentInfoToShow.hasInfo ? 'Informaci√≥n del estudiante extra√≠da correctamente' : 'Informaci√≥n parcial del estudiante'}
                        </div>
                    </div>
                </div>
            ` : `
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 3px solid #b45309;">
                    <h3 style="color: white; margin: 0 0 15px 0;">‚ö†Ô∏è COMPARACI√ìN ETL - INFORMACI√ìN PARCIAL</h3>
                    <p style="margin: 0 0 15px 0; font-size: 1.1rem;">No se pudo extraer completamente la informaci√≥n del estudiante de los nombres de archivo.</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1rem; opacity: 0.9;">
                            <strong>üìÅ Archivos comparados:</strong><br>
                            ‚Ä¢ Original: ${originalDataset.fileName}<br>
                            ‚Ä¢ Procesado: ${processedDataset.fileName}<br>
                            <strong>üïí Fecha de comparaci√≥n:</strong> ${new Date().toLocaleString('es-MX')}<br>
                            <strong>üí° Recomendaci√≥n:</strong> Usa el formato: Nombre-"Tu Nombre"-Grupo-"Tu Grupo"-Tipo-"archivo"
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar la informaci√≥n del estudiante al inicio de los resultados
            const comparisonResults = document.getElementById('comparisonResults');
            
            // Limpiar contenido previo de informaci√≥n del estudiante si existe
            const existingStudentInfo = comparisonResults.querySelector('[data-student-info]');
            if (existingStudentInfo) {
                existingStudentInfo.remove();
            }
            
            // Crear y agregar nueva informaci√≥n del estudiante
            const studentDiv = document.createElement('div');
            studentDiv.setAttribute('data-student-info', 'true');
            studentDiv.innerHTML = studentInfoHTML;
            
            // Insertar al inicio de los resultados
            const firstChild = comparisonResults.firstElementChild;
            comparisonResults.insertBefore(studentDiv, firstChild);
            
            console.log('‚úÖ Informaci√≥n del estudiante agregada al comparador');
            
            // Mostrar resultados principales con n√∫meros congruentes
            document.getElementById('originalErrorCount').textContent = originalErrors;
            document.getElementById('processedErrorCount').textContent = processedErrors;
            document.getElementById('errorsCorrectedCount').textContent = errorsCorrected;
            document.getElementById('totalOriginalErrors').textContent = originalErrors;
            document.getElementById('improvementPercentage').textContent = improvementPercentage >= 0 ? `+${improvementPercentage}%` : `${improvementPercentage}%`;
            
            // Cambiar color seg√∫n mejora
            const improvementElement = document.getElementById('improvementPercentage');
            if (improvementPercentage > 0) {
                improvementElement.style.color = '#10b981';
            } else if (improvementPercentage < 0) {
                improvementElement.style.color = '#ef4444';
            } else {
                improvementElement.style.color = '#f59e0b';
            }
            
            // Generar comparaci√≥n detallada
            const categoryComparisons = generateDetailedComparison(originalDataset, processedDataset);
            
            // Guardar resultados para PDF
            lastComparisonResults = {
                originalScore,
                processedScore,
                improvementPercentage,
                errorsCorrected,
                originalErrors,
                categoryComparisons
            };
            
            // Generar recomendaciones
            generateImprovementRecommendations(originalScore, processedScore, improvementPercentage, errorsCorrected, originalErrors);
            
            // Mostrar resultados
            document.getElementById('comparisonResults').classList.remove('hidden');
            
            // Scroll a resultados
            document.getElementById('comparisonResults').scrollIntoView({ behavior: 'smooth' });
        }

        function generateDetailedComparison(original, processed) {
            const detailedDiv = document.getElementById('detailedComparison');
            
            // Agrupar errores por categor√≠a
            const originalErrorsByCategory = {};
            const processedErrorsByCategory = {};
            
            original.validation.errors.forEach(error => {
                if (!originalErrorsByCategory[error.field]) {
                    originalErrorsByCategory[error.field] = 0;
                }
                originalErrorsByCategory[error.field]++;
            });
            
            processed.validation.errors.forEach(error => {
                if (!processedErrorsByCategory[error.field]) {
                    processedErrorsByCategory[error.field] = 0;
                }
                processedErrorsByCategory[error.field]++;
            });
            
            // Obtener todas las categor√≠as
            const allCategories = new Set([
                ...Object.keys(originalErrorsByCategory),
                ...Object.keys(processedErrorsByCategory)
            ]);
            
            const categoryComparisons = Array.from(allCategories).map(category => {
                const originalErrors = originalErrorsByCategory[category] || 0;
                const processedErrors = processedErrorsByCategory[category] || 0;
                const improvement = originalErrors - processedErrors;
                const improvementPercentage = originalErrors > 0 ? Math.round((improvement / originalErrors) * 100) : 0;
                
                return {
                    category,
                    originalErrors,
                    processedErrors,
                    improvement,
                    improvementPercentage
                };
            }).sort((a, b) => b.improvement - a.improvement);
            
            detailedDiv.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #1a202c; margin: 0 0 20px 0;">üìä Comparaci√≥n Detallada por Categor√≠a</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #dc2626;">${original.validation.errors.length}</div>
                            <div style="color: #7f1d1d;">Errores Originales</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #059669;">${processed.validation.errors.length}</div>
                            <div style="color: #065f46;">Errores Procesados</div>
                        </div>
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #2563eb;">${original.validation.errors.length - processed.validation.errors.length}</div>
                            <div style="color: #1d4ed8;">Errores Corregidos</div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Categor√≠a</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Original</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Procesado</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Mejora</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">% Mejora</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${categoryComparisons.map(comp => `
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-weight: 500;">${comp.category}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #dc2626;">${comp.originalErrors}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center; color: ${comp.processedErrors === 0 ? '#059669' : '#f59e0b'};">${comp.processedErrors}</td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center; color: ${comp.improvement > 0 ? '#059669' : comp.improvement < 0 ? '#dc2626' : '#64748b'};">
                                            ${comp.improvement > 0 ? '+' : ''}${comp.improvement}
                                        </td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center; font-weight: bold; color: ${comp.improvementPercentage > 0 ? '#059669' : comp.improvementPercentage < 0 ? '#dc2626' : '#64748b'};">
                                            ${comp.improvementPercentage > 0 ? '+' : ''}${comp.improvementPercentage}%
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Retornar datos para PDF
            return categoryComparisons;
        }

        function downloadReferenceFile(fileType) {
            if (!currentDataset) {
                showStatus('Genera primero un dataset para descargar archivos de referencia', 'error');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            
            let referenceData, fileName;
            
            switch (fileType) {
                case 'ciudades_estados':
                    fileName = `Nombre-_${studentName}_-Grupo-_${studentGroup}_-Tipo-_ciudades_estados.${format}`;
                    referenceData = [
                        { ciudad: 'Ciudad de M√©xico', estado_correcto: 'CDMX' },
                        { ciudad: 'Guadalajara', estado_correcto: 'Jalisco' },
                        { ciudad: 'Monterrey', estado_correcto: 'Nuevo Le√≥n' },
                        { ciudad: 'Puebla', estado_correcto: 'Puebla' },
                        { ciudad: 'Tijuana', estado_correcto: 'Baja California' },
                        { ciudad: 'Le√≥n', estado_correcto: 'Guanajuato' },
                        { ciudad: 'Ju√°rez', estado_correcto: 'Chihuahua' },
                        { ciudad: 'Torre√≥n', estado_correcto: 'Coahuila' },
                        { ciudad: 'Quer√©taro', estado_correcto: 'Quer√©taro' },
                        { ciudad: 'San Luis Potos√≠', estado_correcto: 'San Luis Potos√≠' },
                        { ciudad: 'M√©rida', estado_correcto: 'Yucat√°n' },
                        { ciudad: 'Mexicali', estado_correcto: 'Baja California' },
                        { ciudad: 'Aguascalientes', estado_correcto: 'Aguascalientes' },
                        { ciudad: 'Cuernavaca', estado_correcto: 'Morelos' },
                        { ciudad: 'Saltillo', estado_correcto: 'Coahuila' },
                        { ciudad: 'Hermosillo', estado_correcto: 'Sonora' },
                        { ciudad: 'Culiac√°n', estado_correcto: 'Sinaloa' },
                        { ciudad: 'Durango', estado_correcto: 'Durango' },
                        { ciudad: 'Toluca', estado_correcto: 'Estado de M√©xico' },
                        { ciudad: 'Tampico', estado_correcto: 'Tamaulipas' }
                    ];
                    break;
                    
                case 'departamentos_validos':
                    fileName = `Nombre-_${studentName}_-Grupo-_${studentGroup}_-Tipo-_departamentos_validos.${format}`;
                    referenceData = [
                        { departamento_valido: 'Ventas' },
                        { departamento_valido: 'Marketing' },
                        { departamento_valido: 'Sistemas' },
                        { departamento_valido: 'Recursos Humanos' },
                        { departamento_valido: 'Finanzas' },
                        { departamento_valido: 'Operaciones' }
                    ];
                    break;
                    
                case 'paises_validos':
                    fileName = `Nombre-_${studentName}_-Grupo-_${studentGroup}_-Tipo-_paises_validos.${format}`;
                    referenceData = [
                        { pais_valido: 'M√©xico', codigo_iso: 'MX' },
                        { pais_valido: 'Mexico', codigo_iso: 'MX' }
                    ];
                    break;
                    
                default:
                    showStatus('Tipo de archivo no reconocido', 'error');
                    return;
            }
            
            try {
                let content, mimeType;
                
                if (format === 'csv') {
                    content = generateCSVContent(referenceData);
                    content = '\ufeff' + content; // Agregar BOM para UTF-8
                    mimeType = 'text/csv;charset=utf-8;';
                } else {
                    const ws = XLSX.utils.json_to_sheet(referenceData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, fileType.replace('_', ' '));
                    content = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                }
                
                const blob = new Blob([content], { type: mimeType });
                downloadFile(blob, fileName, mimeType);
                
                showStatus('Descargando ' + fileName + '... (' + referenceData.length + ' registros de referencia)', 'success');
                
            } catch (error) {
                console.error('Error en descarga de archivo de referencia:', error);
                showStatus('Error al descargar: ' + error.message, 'error');
            }
        }

        // Variables globales para almacenar resultados de validaci√≥n
        let lastValidationResults = null;
        let lastComparisonResults = null;

        // Funci√≥n para generar c√≥digo QR mejorado y legible
        function generateQRCode(text, size = 400) {
            try {
                // Limpiar y optimizar el texto para QR
                const cleanText = text
                    .replace(/\n/g, ' | ') // Reemplazar saltos de l√≠nea con separador
                    .replace(/[^\x20-\x7E]/g, '') // Remover caracteres no ASCII
                    .substring(0, 800); // Limitar longitud para mejor legibilidad
                
                const canvas = document.createElement('canvas');
                const qr = new QRious({
                    element: canvas,
                    value: cleanText,
                    size: size,
                    background: 'white',
                    foreground: 'black',
                    level: 'H', // Nivel de correcci√≥n de errores alto para mejor legibilidad
                    padding: 20 // M√°s padding para mejor escaneado m√≥vil
                });
                
                console.log('QR generado exitosamente:', cleanText.substring(0, 100) + '...');
                return canvas.toDataURL('image/png');
            } catch (error) {
                console.error('Error generando QR:', error);
                // QR de fallback con informaci√≥n m√≠nima
                const fallbackText = `UTTec-ETL-${new Date().toISOString().split('T')[0]}`;
                const canvas = document.createElement('canvas');
                const qr = new QRious({
                    element: canvas,
                    value: fallbackText,
                    size: size,
                    background: 'white',
                    foreground: 'black',
                    level: 'H',
                    padding: 20
                });
                return canvas.toDataURL('image/png');
            }
        }

        // Funci√≥n para verificar espacio disponible en p√°gina
        function checkPageSpace(doc, currentY, requiredSpace) {
            const pageHeight = 297; // A4 height in mm
            const bottomMargin = 50; // Espacio reservado para pie de p√°gina
            return (currentY + requiredSpace) > (pageHeight - bottomMargin);
        }

        // Funci√≥n para crear marcos responsivos con texto bien ajustado
        function createResponsiveSection(doc, title, content, yPosition, bgColor = [248, 250, 252], borderColor = [226, 232, 240], titleColor = [30, 41, 59]) {
            const leftMargin = 20;
            const contentWidth = 170;
            const padding = 10; // M√°s padding para mejor espaciado
            const lineHeight = 8; // Espaciado consistente entre l√≠neas
            const titleHeight = 12; // M√°s espacio para el t√≠tulo
            
            // Calcular l√≠neas de contenido con mejor control de ancho
            let contentLines = [];
            if (Array.isArray(content)) {
                content.forEach(item => {
                    if (typeof item === 'string') {
                        // Dividir l√≠neas largas usando el ancho real disponible
                        const maxWidth = contentWidth - (padding * 2);
                        const splitLines = doc.splitTextToSize(item, maxWidth);
                        contentLines = contentLines.concat(splitLines);
                    } else {
                        contentLines.push(String(item));
                    }
                });
            } else if (typeof content === 'string') {
                const maxWidth = contentWidth - (padding * 2);
                contentLines = doc.splitTextToSize(content, maxWidth);
            }
            
            // Calcular altura total necesaria con mejor precisi√≥n
            const contentHeight = contentLines.length * lineHeight;
            const totalHeight = titleHeight + contentHeight + (padding * 2) + 5; // Espaciado m√°s controlado
            
            // Verificar si necesitamos nueva p√°gina
            if (checkPageSpace(doc, yPosition, totalHeight)) {
                yPosition = addNewPageWithHeader(doc, title.toUpperCase());
            }
            
            // Dibujar marco de fondo
            doc.setFillColor(...bgColor);
            doc.rect(leftMargin, yPosition, contentWidth, totalHeight, 'F');
            
            // Dibujar borde
            doc.setDrawColor(...borderColor);
            doc.setLineWidth(0.5);
            doc.rect(leftMargin, yPosition, contentWidth, totalHeight, 'S');
            
            // Agregar t√≠tulo con mejor espaciado
            doc.setTextColor(...titleColor);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(title, leftMargin + padding, yPosition + padding + 3);
            
            // Agregar contenido con espaciado uniforme
            doc.setFontSize(9);
            doc.setTextColor(30, 30, 30);
            
            let currentY = yPosition + titleHeight + padding;
            contentLines.forEach(line => {
                // Detectar l√≠neas que necesitan resaltado (con ***)
                if (line.includes('***')) {
                    // Solo usar negrita, sin fondos complejos
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10); // Ligeramente m√°s grande
                    
                    // Limpiar asteriscos
                    const cleanLine = line.replace(/\*\*\*/g, '').trim();
                    const maxWidth = contentWidth - (padding * 2);
                    doc.text(cleanLine, leftMargin + padding, currentY, { maxWidth: maxWidth });
                    
                    // Restaurar formato normal
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                } else {
                    // Texto normal
                    const maxWidth = contentWidth - (padding * 2);
                    doc.text(line, leftMargin + padding, currentY, { maxWidth: maxWidth });
                }
                
                // Espaciado uniforme entre todas las l√≠neas
                currentY += lineHeight;
            });
            
            return yPosition + totalHeight + 10; // Espacio consistente entre secciones
        }

        // Funci√≥n para agregar nueva p√°gina con encabezado
        function addNewPageWithHeader(doc, title) {
            doc.addPage();
            
            // Encabezado simplificado para p√°ginas adicionales
            doc.setFillColor(248, 250, 252);
            doc.rect(0, 0, 210, 25, 'F');
            
            doc.setTextColor(55, 65, 81);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 105, 15, { align: 'center' });
            
            return 35; // Retorna nueva posici√≥n Y
        }

        // Funci√≥n para agregar secci√≥n de QR dedicada con mejor dise√±o responsivo
        function addQRSection(doc, qrText, yPosition) {
            // Verificar si hay espacio suficiente (necesitamos ~85mm)
            if (checkPageSpace(doc, yPosition, 85)) {
                yPosition = addNewPageWithHeader(doc, 'CODIGO QR DE VERIFICACION');
            }
            
            const leftMargin = 20;
            const contentWidth = 170;
            const sectionHeight = 80;
            
            // Secci√≥n dedicada para QR con mejor dise√±o responsivo
            doc.setFillColor(240, 249, 255);
            doc.rect(leftMargin, yPosition, contentWidth, sectionHeight, 'F');
            doc.setDrawColor(59, 130, 246);
            doc.setLineWidth(1.5);
            doc.rect(leftMargin, yPosition, contentWidth, sectionHeight, 'S');
            
            // T√≠tulo de la secci√≥n QR con mejor espaciado
            doc.setTextColor(30, 58, 138);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('CODIGO QR DE VERIFICACION', 105, yPosition + 12, { align: 'center' });
            
            // Generar QR optimizado para m√≥viles
            const qrDataURL = generateQRCode(qrText, 400); // QR de alta resoluci√≥n
            const qrSize = 50; // Tama√±o m√°s grande en el PDF
            const qrX = 105 - (qrSize / 2); // Centrar horizontalmente
            const qrY = yPosition + 18;
            
            try {
                doc.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);
            } catch (error) {
                console.error('Error agregando QR al PDF:', error);
                // Mostrar mensaje de error en lugar del QR
                doc.setFontSize(10);
                doc.setTextColor(220, 38, 38);
                doc.text('Error generando QR', 105, qrY + 25, { align: 'center' });
            }
            
            // Instrucciones debajo del QR con mejor espaciado
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(55, 65, 81);
            doc.text('Escanea este codigo QR con tu telefono movil para verificar', 105, yPosition + 72, { align: 'center' });
            doc.text('la autenticidad y detalles completos de este documento', 105, yPosition + 77, { align: 'center' });
            
            return yPosition + 85; // Retorna nueva posici√≥n Y
        }

        // Funci√≥n para generar PDF del dataset generado con mejor dise√±o responsivo
        function generateDatasetPDF() {
            if (!currentDataset) {
                showStatus('No hay dataset para generar reporte PDF', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n de m√°rgenes mejorados
            const leftMargin = 20;
            const rightMargin = 20;
            const topMargin = 15;
            const contentWidth = 210 - leftMargin - rightMargin; // Ancho disponible para contenido
            
            let yPosition = topMargin;
            
            // Encabezado institucional mejorado con mejores m√°rgenes
            doc.setFillColor(16, 185, 129);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Universidad Tecnologica de Tecamac', 105, 18, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Division de Tecnologias de la Informacion y Comunicacion', 105, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('EVALUACION ETL - PENTAHO PDI', 105, 36, { align: 'center' });
            
            yPosition = 55;
            
            // Informaci√≥n del estudiante usando marco responsivo
            const studentName = document.getElementById('studentName').value;
            const studentGroup = document.getElementById('studentGroup').value;
            const datasetName = document.getElementById('datasetName').value;
            
            const studentInfo = [
                `*** Estudiante: ${studentName} ***`,
                `*** Grupo: ${studentGroup} ***`,
                `*** Docente: MTI Jesus E. Romero Moreno ***`,
                `Fecha: ${new Date().toLocaleDateString('es-MX')}`,
                `Hora: ${new Date().toLocaleTimeString('es-MX')}`
            ];
            
            yPosition = createResponsiveSection(doc, 'INFORMACION DEL ESTUDIANTE', studentInfo, yPosition);
            
            // Informaci√≥n del dataset usando marco responsivo con datos exactos
            const datasetInfo = [
                `*** Archivo: ${datasetName}.${document.getElementById('fileFormat').value} ***`,
                `*** Registros totales: ${currentDataset.data.length} ***`,
                `*** Errores introducidos: ${originalErrors.length} ***`,
                `*** Registros con errores: ${currentDataset.metadata.errorRecords} ***`,
                `*** Porcentaje de errores: ${currentDataset.metadata.errorPercentage}% ***`,
                `Formato de archivo: ${document.getElementById('fileFormat').value.toUpperCase()}`,
                `Fecha de generacion: ${new Date().toLocaleDateString('es-MX')}`,
                `Hora de generacion: ${new Date().toLocaleTimeString('es-MX')}`
            ];
            
            yPosition = createResponsiveSection(doc, 'DATASET GENERADO', datasetInfo, yPosition, [240, 249, 255], [59, 130, 246], [30, 58, 138]);
            
            // Resumen de errores por tipo usando marco responsivo
            const errorsByType = {};
            originalErrors.forEach(error => {
                if (!errorsByType[error.type]) {
                    errorsByType[error.type] = 0;
                }
                errorsByType[error.type]++;
            });
            
            const errorSummary = Object.keys(errorsByType).map(type => {
                const typeName = getErrorTypeName(type);
                const count = errorsByType[type];
                return `${typeName}: ${count} errores`;
            });
            
            if (errorSummary.length > 0) {
                yPosition = createResponsiveSection(doc, 'RESUMEN DE ERRORES POR TIPO', errorSummary, yPosition, [254, 242, 242], [239, 68, 68], [153, 27, 27]);
            }
            
            // Secci√≥n QR dedicada con texto optimizado para m√≥viles
            const qrText = `UTTec-ETL | ${studentName} | ${studentGroup} | ${datasetName} | Reg:${currentDataset.data.length} | Err:${originalErrors.length} | ${new Date().toLocaleDateString('es-MX')}`;
            yPosition = addQRSection(doc, qrText, yPosition);
            
            // Nueva p√°gina para detalles de errores
            yPosition = addNewPageWithHeader(doc, 'DETALLE DE ERRORES ENCONTRADOS');
            
            // Configurar fuentes est√°ndar para toda la secci√≥n de errores
            const standardTitleFont = 12;
            const standardErrorNumberFont = 9;
            const standardDescriptionFont = 8;
            const standardHintFont = 8;
            
            doc.setFontSize(standardTitleFont);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('DETALLE DE ERRORES ENCONTRADOS', leftMargin, yPosition);
            
            yPosition += 15;
            
            // Mostrar errores con mejor control de p√°gina y fuentes estandarizadas
            const errorsToShow = originalErrors.slice(0, 40); // Reducir para mejor legibilidad
            
            errorsToShow.forEach((error, index) => {
                // Verificar espacio para el error completo (necesitamos ~15mm por error)
                if (checkPageSpace(doc, yPosition, 15)) {
                    yPosition = addNewPageWithHeader(doc, 'DETALLE DE ERRORES (CONTINUACION)');
                    // Reconfigurar fuentes despu√©s de nueva p√°gina
                    doc.setFontSize(standardTitleFont);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('DETALLE DE ERRORES ENCONTRADOS (CONTINUACION)', leftMargin, yPosition);
                    yPosition += 15;
                }
                
                // N√∫mero de error con fuente estandarizada
                doc.setFontSize(standardErrorNumberFont);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(`${index + 1}. Registro ${error.index + 1} - Campo: ${error.field}`, leftMargin, yPosition);
                yPosition += 6;
                
                // Descripci√≥n con fuente estandarizada
                doc.setFontSize(standardDescriptionFont);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(55, 65, 81);
                
                // Dividir descripci√≥n larga en m√∫ltiples l√≠neas
                const description = error.description;
                const maxLineLength = 85;
                if (description.length > maxLineLength) {
                    const words = description.split(' ');
                    let currentLine = '';
                    
                    words.forEach(word => {
                        if ((currentLine + word).length > maxLineLength) {
                            doc.text(`   ${currentLine}`, leftMargin, yPosition);
                            yPosition += 5;
                            currentLine = word + ' ';
                        } else {
                            currentLine += word + ' ';
                        }
                    });
                    
                    if (currentLine.trim()) {
                        doc.text(`   ${currentLine}`, leftMargin, yPosition);
                        yPosition += 5;
                    }
                } else {
                    doc.text(`   ${description}`, leftMargin, yPosition);
                    yPosition += 5;
                }
                
                // Hint de soluci√≥n con fuente estandarizada
                if (error.solutionHint) {
                    doc.setFontSize(standardHintFont);
                    doc.setTextColor(0, 120, 0);
                    const hint = error.solutionHint;
                    if (hint.length > maxLineLength) {
                        const hintWords = hint.split(' ');
                        let currentHintLine = '';
                        
                        hintWords.forEach(word => {
                            if ((currentHintLine + word).length > maxLineLength) {
                                doc.text(`   Solucion: ${currentHintLine}`, leftMargin, yPosition);
                                yPosition += 5;
                                currentHintLine = word + ' ';
                            } else {
                                currentHintLine += word + ' ';
                            }
                        });
                        
                        if (currentHintLine.trim()) {
                            doc.text(`   ${currentHintLine}`, leftMargin, yPosition);
                            yPosition += 5;
                        }
                    } else {
                        doc.text(`   Solucion: ${hint}`, leftMargin, yPosition);
                        yPosition += 5;
                    }
                }
                
                yPosition += 4; // Espacio entre errores
            });
            
            if (originalErrors.length > 40) {
                yPosition += 10;
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(`... y ${originalErrors.length - 40} errores mas (consulta el dataset completo)`, leftMargin, yPosition);
            }
            
            // Pie de p√°gina mejorado en todas las p√°ginas
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // N√∫mero de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Pagina ${i} de ${pageCount}`, 105, 275, { align: 'center' });
                
                // Texto de descargo con mejor espaciado
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                const disclaimerLines = [
                    'Este reporte es generado por el laboratorio ETL Data Quality Lab de la UTTec. Carece de validez oficial y tiene un caracter',
                    'estrictamente informativo previo a la emision de las calificaciones finales. Su proposito es que el estudiante conozca los',
                    'resultados obtenidos en el procesamiento y validacion de su archivo de datos, los cuales se integran con el flujo de trabajo'
                ];
                
                let yPos = 280;
                disclaimerLines.forEach(line => {
                    if (yPos <= 290) { // Mejor control de l√≠mites
                        doc.text(line, 105, yPos, { align: 'center' });
                        yPos += 3;
                    }
                });
            }
            
            // Descargar PDF
            const fileName = `Reporte_Dataset_${studentName.replace(/\s+/g, '_')}_${studentGroup}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showStatus(`Reporte PDF generado: ${fileName}`, 'success');
        }

        // Funci√≥n para generar PDF de validaci√≥n individual con mejor dise√±o responsivo
        function generateValidationPDF() {
            if (!lastValidationResults) {
                showStatus('No hay resultados de validaci√≥n para generar reporte PDF', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n de m√°rgenes mejorados
            const leftMargin = 20;
            const rightMargin = 20;
            const topMargin = 15;
            const contentWidth = 210 - leftMargin - rightMargin;
            
            const results = lastValidationResults;
            let yPosition = topMargin;
            
            // Encabezado institucional mejorado
            doc.setFillColor(16, 185, 129);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Universidad Tecnologica de Tecamac', 105, 18, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Division de Tecnologias de la Informacion y Comunicacion', 105, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('REPORTE DE VALIDACION DE CALIDAD DE DATOS', 105, 36, { align: 'center' });
            
            yPosition = 55;
            
            // Informaci√≥n del estudiante usando marco responsivo
            const validationStudentInfo = [];
            if (results.studentInfo && results.studentInfo.hasInfo) {
                validationStudentInfo.push(
                    `*** Estudiante: ${results.studentInfo.studentName} ***`,
                    `*** Grupo: ${results.studentInfo.studentGroup} ***`,
                    `*** Archivo: ${results.studentInfo.fileType} ***`
                );
            } else {
                validationStudentInfo.push(
                    '*** Estudiante: No identificado ***',
                    '*** Grupo: No identificado ***',
                    '*** Archivo: No identificado ***'
                );
            }
            
            validationStudentInfo.push(
                `*** Docente: MTI Jesus E. Romero Moreno ***`,
                `*** Fecha: ${new Date().toLocaleDateString('es-MX')} ***`,
                `*** Hora: ${new Date().toLocaleTimeString('es-MX')} ***`
            );
            
            yPosition = createResponsiveSection(doc, 'INFORMACION DEL ESTUDIANTE', validationStudentInfo, yPosition);
            
            // Puntuaci√≥n de calidad usando marco responsivo con datos exactos
            const scoreColor = results.score >= 98 ? [5, 150, 105] : results.score >= 89 ? [56, 161, 105] : results.score >= 85 ? [245, 158, 11] : [239, 68, 68];
            const scoreBgColor = results.score >= 98 ? [240, 253, 244] : results.score >= 89 ? [236, 253, 245] : results.score >= 85 ? [255, 251, 235] : [254, 242, 242];
            
            // Usar exactamente la misma l√≥gica que en displayUniversalValidationResults
            let qualityLabel;
            if (results.score >= 98) {
                qualityLabel = 'EXCELENTE';
            } else if (results.score >= 89) {
                qualityLabel = 'ACEPTABLE';
            } else if (results.score >= 85) {
                qualityLabel = 'SATISFACTORIO';
            } else {
                qualityLabel = 'NO ACEPTABLE';
            }
            
            const qualityInfo = [
                `*** PUNTUACION DE CALIDAD: ${results.score}% ***`,
                `${results.summary.recordsWithoutErrors} registros sin errores de ${results.summary.totalRecords} analizados`,
                `${results.summary.recordsWithErrors} registros con errores`,
                `*** Clasificacion: ${qualityLabel} ***`,
                `Validaciones exitosas: ${results.summary.passedChecks} de ${results.summary.totalChecks}`
            ];
            
            yPosition = createResponsiveSection(doc, 'RESULTADO DE VALIDACION', qualityInfo, yPosition, scoreBgColor, scoreColor, scoreColor);
            
            // Resumen estad√≠stico usando marco responsivo con datos exactos
            const statisticsInfo = [
                `Total de registros analizados: ${results.summary.totalRecords}`,
                `Registros sin errores: ${results.summary.recordsWithoutErrors}`,
                `Registros con errores: ${results.summary.recordsWithErrors}`,
                `Total de validaciones realizadas: ${results.summary.totalChecks}`,
                `Validaciones exitosas: ${results.summary.passedChecks}`,
                `Validaciones fallidas: ${results.summary.failedChecks}`,
                `Porcentaje de exito: ${Math.round((results.summary.passedChecks / results.summary.totalChecks) * 100)}%`,
                `Calculo de calidad: (${results.summary.recordsWithoutErrors} √∑ ${results.summary.totalRecords}) √ó 100 = ${results.score}%`
            ];
            
            yPosition = createResponsiveSection(doc, 'RESUMEN ESTADISTICO', statisticsInfo, yPosition, [240, 249, 255], [59, 130, 246], [30, 58, 138]);
            
            // Errores por categor√≠a
            if (results.summary.errorsByCategory && Object.keys(results.summary.errorsByCategory).length > 0) {
                const categoryCount = Object.keys(results.summary.errorsByCategory).length;
                const sectionHeight = Math.max(30, categoryCount * 7 + 20);
                
                if (checkPageSpace(doc, yPosition, sectionHeight)) {
                    yPosition = addNewPageWithHeader(doc, 'ERRORES POR CATEGORIA');
                }
                
                doc.setFillColor(254, 242, 242);
                doc.rect(leftMargin, yPosition, contentWidth, sectionHeight, 'F');
                doc.setDrawColor(239, 68, 68);
                doc.setLineWidth(0.5);
                doc.rect(leftMargin, yPosition, contentWidth, sectionHeight, 'S');
                
                doc.setTextColor(153, 27, 27);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text('ERRORES POR CATEGORIA', leftMargin + 5, yPosition + 8);
                
                yPosition += 15;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(127, 29, 29);
                
                Object.keys(results.summary.errorsByCategory).forEach(category => {
                    const count = results.summary.errorsByCategory[category];
                    doc.text(`- ${category}: ${count} errores`, leftMargin + 10, yPosition);
                    yPosition += 7;
                });
                
                yPosition += 10;
            }
            
            // Secci√≥n QR dedicada con texto optimizado
            const qrText = results.studentInfo ? 
                `UTTec-VAL | ${results.studentInfo.studentName} | ${results.studentInfo.studentGroup} | Cal:${results.score}% | Reg:${results.summary.totalRecords} | Err:${results.summary.recordsWithErrors} | ${new Date().toLocaleDateString('es-MX')}` :
                `UTTec-VAL | Calidad:${results.score}% | Registros:${results.summary.totalRecords} | Errores:${results.summary.recordsWithErrors} | ${new Date().toLocaleDateString('es-MX')}`;
            
            yPosition = addQRSection(doc, qrText, yPosition);
            
            // Pie de p√°gina mejorado
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // N√∫mero de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Pagina ${i} de ${pageCount}`, 105, 275, { align: 'center' });
                
                // Texto de descargo con mejor espaciado
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                const disclaimerLines = [
                    'Este reporte es generado por el laboratorio ETL Data Quality Lab de la UTTec. Carece de validez oficial y tiene un caracter',
                    'estrictamente informativo previo a la emision de las calificaciones finales. Su proposito es que el estudiante conozca los',
                    'resultados obtenidos en el procesamiento y validacion de su archivo de datos, los cuales se integran con el flujo de trabajo'
                ];
                
                let yPos = 280;
                disclaimerLines.forEach(line => {
                    if (yPos <= 290) { // Mejor control de l√≠mites
                        doc.text(line, 105, yPos, { align: 'center' });
                        yPos += 3;
                    }
                });
            }
            
            // Descargar PDF
            const studentName = results.studentInfo?.studentName || 'Estudiante';
            const studentGroup = results.studentInfo?.studentGroup || 'Grupo';
            const fileName = `Reporte_Validacion_${studentName.replace(/\s+/g, '_')}_${studentGroup}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showStatus(`Reporte de validacion PDF generado: ${fileName}`, 'success');
        }

        // Funci√≥n para generar PDF de comparaci√≥n ETL con mejor dise√±o responsivo
        function generateComparisonPDF() {
            if (!originalDataset || !processedDataset || !lastComparisonResults) {
                showStatus('No hay resultados de comparaci√≥n para generar reporte PDF', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n de m√°rgenes mejorados
            const leftMargin = 20;
            const rightMargin = 20;
            const topMargin = 15;
            const contentWidth = 210 - leftMargin - rightMargin;
            
            let yPosition = topMargin;
            
            // Encabezado institucional mejorado
            doc.setFillColor(59, 130, 246);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Universidad Tecnologica de Tecamac', 105, 18, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Division de Tecnologias de la Informacion y Comunicacion', 105, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('REPORTE DE COMPARACION ETL - PENTAHO PDI', 105, 36, { align: 'center' });
            
            yPosition = 55;
            
            // Informaci√≥n del estudiante usando marco responsivo
            const studentInfo = originalDataset.studentInfo || processedDataset.studentInfo;
            const comparisonStudentInfo = [];
            
            if (studentInfo && studentInfo.hasInfo) {
                comparisonStudentInfo.push(
                    `*** Estudiante: ${studentInfo.studentName} ***`,
                    `*** Grupo: ${studentInfo.studentGroup} ***`,
                    `*** Archivos: Original y Procesado ***`
                );
            } else {
                comparisonStudentInfo.push(
                    '*** Estudiante: No identificado ***',
                    '*** Grupo: No identificado ***',
                    '*** Archivos: Original y Procesado ***'
                );
            }
            
            comparisonStudentInfo.push(
                `*** Docente: MTI Jesus E. Romero Moreno ***`,
                `*** Fecha: ${new Date().toLocaleDateString('es-MX')} ***`,
                `*** Hora: ${new Date().toLocaleTimeString('es-MX')} ***`
            );
            
            yPosition = createResponsiveSection(doc, 'INFORMACION DEL ESTUDIANTE', comparisonStudentInfo, yPosition);
            
            // Resultado principal de la mejora usando datos exactos del comparador
            const originalErrors = originalDataset.validation.errors.length;
            const processedErrors = processedDataset.validation.errors.length;
            const errorsCorrected = originalErrors - processedErrors;
            const improvementPercentage = originalErrors > 0 ? Math.round((errorsCorrected / originalErrors) * 1000) / 10 : 0;
            
            // Usar exactamente los mismos datos que se muestran en la interfaz
            const displayedOriginalErrors = parseInt(document.getElementById('originalErrorCount')?.textContent || originalErrors);
            const displayedProcessedErrors = parseInt(document.getElementById('processedErrorCount')?.textContent || processedErrors);
            const displayedErrorsCorrected = parseInt(document.getElementById('errorsCorrectedCount')?.textContent || errorsCorrected);
            const displayedImprovementPercentage = parseFloat(document.getElementById('improvementPercentage')?.textContent?.replace(/[+%]/g, '') || improvementPercentage);
            
            const improvementInfo = [
                `*** MEJORA ETL: ${displayedImprovementPercentage >= 0 ? '+' : ''}${displayedImprovementPercentage}% ***`,
                `*** Errores originales: ${displayedOriginalErrors} ***`,
                `*** Errores procesados: ${displayedProcessedErrors} ***`,
                `*** Errores corregidos: ${displayedErrorsCorrected} ***`,
                `*** Calidad original: ${originalDataset.validation.score}% ***`,
                `*** Calidad procesada: ${processedDataset.validation.score}% ***`
            ];
            
            const improvementColor = displayedImprovementPercentage >= 0 ? [5, 150, 105] : [239, 68, 68];
            const improvementBgColor = displayedImprovementPercentage >= 0 ? [240, 253, 244] : [254, 242, 242];
            
            yPosition = createResponsiveSection(doc, 'RESULTADO DE MEJORA ETL', improvementInfo, yPosition, improvementBgColor, improvementColor, improvementColor);
            
            // Comparaci√≥n detallada de archivos usando marco responsivo
            const comparisonDetails = [
                'ARCHIVO ORIGINAL:',
                `- Nombre: ${originalDataset.fileName}`,
                `- Registros: ${originalDataset.data.length}`,
                `- Errores: ${originalErrors}`,
                `- Calidad: ${originalDataset.validation.score}%`,
                '',
                'ARCHIVO PROCESADO:',
                `- Nombre: ${processedDataset.fileName}`,
                `- Registros: ${processedDataset.data.length}`,
                `- Errores: ${processedErrors}`,
                `- Calidad: ${processedDataset.validation.score}%`
            ];
            
            yPosition = createResponsiveSection(doc, 'COMPARACION DETALLADA', comparisonDetails, yPosition, [240, 249, 255], [59, 130, 246], [30, 58, 138]);
            
            // An√°lisis de mejora por categor√≠a usando dise√±o de 2 columnas sin marco
            if (lastComparisonResults.categoryComparisons && lastComparisonResults.categoryComparisons.length > 0) {
                // Calcular altura necesaria para la secci√≥n completa
                const categoriesCount = Math.min(lastComparisonResults.categoryComparisons.length, 10);
                const estimatedHeight = 25 + Math.ceil(categoriesCount / 2) * 12; // T√≠tulo + categor√≠as en 2 columnas
                
                // Verificar si necesitamos nueva p√°gina antes de crear la secci√≥n
                if (checkPageSpace(doc, yPosition, estimatedHeight)) {
                    yPosition = addNewPageWithHeader(doc, 'MEJORAS POR CATEGORIA');
                }
                
                // T√≠tulo de la secci√≥n sin marco
                doc.setTextColor(153, 27, 27);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('MEJORAS POR CATEGORIA', leftMargin, yPosition);
                yPosition += 15;
                
                // Configurar columnas
                const leftColumnX = leftMargin;
                const rightColumnX = leftMargin + 85; // Mitad del ancho disponible
                const columnWidth = 80;
                
                // Dividir categor√≠as en dos columnas
                const categories = lastComparisonResults.categoryComparisons.slice(0, 10);
                let leftColumnY = yPosition;
                let rightColumnY = yPosition;
                
                categories.forEach((comp, index) => {
                    const improvementText = comp.improvement >= 0 ? `+${comp.improvement}` : `${comp.improvement}`;
                    const percentageText = comp.improvementPercentage >= 0 ? `+${comp.improvementPercentage}%` : `${comp.improvementPercentage}%`;
                    
                    // Determinar en qu√© columna va
                    const isLeftColumn = index % 2 === 0;
                    const currentX = isLeftColumn ? leftColumnX : rightColumnX;
                    let currentY = isLeftColumn ? leftColumnY : rightColumnY;
                    
                    // Verificar espacio en la columna actual
                    if (checkPageSpace(doc, currentY, 12)) {
                        yPosition = addNewPageWithHeader(doc, 'MEJORAS POR CATEGORIA (CONTINUACION)');
                        leftColumnY = yPosition;
                        rightColumnY = yPosition;
                        currentY = yPosition;
                    }
                    
                    // Nombre de la categor√≠a
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(127, 29, 29);
                    const categoryName = comp.category.length > 18 ? comp.category.substring(0, 15) + '...' : comp.category;
                    doc.text(categoryName, currentX, currentY);
                    currentY += 4;
                    
                    // Detalles de la mejora
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(75, 85, 99);
                    doc.text(`Orig: ${comp.originalErrors} | Proc: ${comp.processedErrors}`, currentX, currentY);
                    currentY += 3;
                    doc.text(`Mejora: ${improvementText} (${percentageText})`, currentX, currentY);
                    currentY += 6; // Espacio entre categor√≠as
                    
                    // Actualizar posici√≥n Y de la columna correspondiente
                    if (isLeftColumn) {
                        leftColumnY = currentY;
                    } else {
                        rightColumnY = currentY;
                    }
                });
                
                // Actualizar yPosition al m√°ximo de ambas columnas
                yPosition = Math.max(leftColumnY, rightColumnY);
                
                // Mensaje si hay m√°s categor√≠as
                if (lastComparisonResults.categoryComparisons.length > 10) {
                    yPosition += 5;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(100, 100, 100);
                    doc.text(`... y ${lastComparisonResults.categoryComparisons.length - 10} categorias mas`, leftMargin, yPosition);
                    yPosition += 8;
                }
                
                yPosition += 10; // Espacio despu√©s de la secci√≥n
            }
            
            // Secci√≥n QR dedicada con texto optimizado
            const qrText = studentInfo ? 
                `UTTec-CMP | ${studentInfo.studentName} | ${studentInfo.studentGroup} | Mejora:${improvementPercentage}% | Orig:${originalErrors} | Proc:${processedErrors} | Corr:${errorsCorrected} | ${new Date().toLocaleDateString('es-MX')}` :
                `UTTec-CMP | Mejora:${improvementPercentage}% | Orig:${originalErrors} | Proc:${processedErrors} | Corr:${errorsCorrected} | ${new Date().toLocaleDateString('es-MX')}`;
            
            yPosition = addQRSection(doc, qrText, yPosition);
            
            // Pie de p√°gina mejorado en todas las p√°ginas
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // N√∫mero de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Pagina ${i} de ${pageCount}`, 105, 275, { align: 'center' });
                
                // Texto de descargo con mejor espaciado
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                const disclaimerLines = [
                    'Este reporte es generado por el laboratorio ETL Data Quality Lab de la UTTec. Carece de validez oficial y tiene un caracter',
                    'estrictamente informativo previo a la emision de las calificaciones finales. Su proposito es que el estudiante conozca los',
                    'resultados obtenidos en el procesamiento y validacion de su archivo de datos, los cuales se integran con el flujo de trabajo'
                ];
                
                let yPos = 280;
                disclaimerLines.forEach(line => {
                    if (yPos <= 290) { // Mejor control de l√≠mites
                        doc.text(line, 105, yPos, { align: 'center' });
                        yPos += 3;
                    }
                });
            }
            
            // Descargar PDF
            const studentName = studentInfo?.studentName || 'Estudiante';
            const studentGroup = studentInfo?.studentGroup || 'Grupo';
            const fileName = `Reporte_Comparacion_ETL_${studentName.replace(/\s+/g, '_')}_${studentGroup}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showStatus(`Reporte de comparacion ETL PDF generado: ${fileName}`, 'success');
        }

        function generateImprovementRecommendations(originalScore, processedScore, improvementPercentage, errorsCorrected, originalErrors) {
            const recommendationsDiv = document.getElementById('improvementRecommendations');
            
            let level, message, nextSteps, color;
            
            // Validar congruencia de n√∫meros
            const processedErrors = originalErrors - errorsCorrected;
            const actualImprovementPercentage = originalErrors > 0 ? Math.round((errorsCorrected / originalErrors) * 1000) / 10 : 0;
            
            if (actualImprovementPercentage >= 80.0) {
                level = "üèÜ Excelente Mejora";
                color = "#059669";
                message = `¬°Felicitaciones! Has corregido ${errorsCorrected} de ${originalErrors} errores originales (${actualImprovementPercentage}% de mejora). Quedan ${processedErrors} errores por resolver. Tu proceso ETL en Pentaho PDI est√° funcionando muy bien.`;
                nextSteps = [
                    "Documenta las transformaciones exitosas para futuros proyectos",
                    "Considera automatizar este proceso para datos en producci√≥n",
                    "Implementa monitoreo continuo de calidad de datos",
                    "Comparte las mejores pr√°cticas con tu equipo"
                ];
            } else if (actualImprovementPercentage >= 60.0) {
                level = "‚úÖ Buena Mejora";
                color = "#059669";
                message = `Has logrado una mejora notable corrigiendo ${errorsCorrected} de ${originalErrors} errores originales (${actualImprovementPercentage}% de mejora). Quedan ${processedErrors} errores por resolver. El proceso ETL est√° dando buenos resultados.`;
                nextSteps = [
                    "Revisa las categor√≠as que a√∫n tienen errores",
                    "Optimiza las transformaciones para mayor efectividad",
                    "Considera validaciones adicionales en tiempo real",
                    "Implementa alertas para errores cr√≠ticos"
                ];
            } else if (actualImprovementPercentage >= 30.0) {
                level = "üìà Mejora Moderada";
                color = "#f59e0b";
                message = `Has corregido ${errorsCorrected} de ${originalErrors} errores originales (${actualImprovementPercentage}% de mejora). Quedan ${processedErrors} errores por resolver. Hay oportunidad de optimizar m√°s el proceso ETL.`;
                nextSteps = [
                    "Analiza los errores que persisten despu√©s del procesamiento",
                    "Revisa la configuraci√≥n de los componentes PDI utilizados",
                    "Considera agregar m√°s pasos de validaci√≥n y limpieza",
                    "Verifica que las reglas de negocio est√©n correctamente implementadas"
                ];
            } else if (actualImprovementPercentage > 0) {
                level = "‚ö†Ô∏è Mejora M√≠nima";
                color = "#f59e0b";
                message = `Solo has corregido ${errorsCorrected} de ${originalErrors} errores originales (${actualImprovementPercentage}% de mejora). Quedan ${processedErrors} errores por resolver. El proceso ETL no est√° generando mejoras significativas.`;
                nextSteps = [
                    "Revisa completamente el flujo de transformaci√≥n en PDI",
                    "Verifica que los componentes est√©n configurados correctamente",
                    "Considera usar componentes m√°s espec√≠ficos para cada tipo de error",
                    "Implementa validaciones m√°s estrictas en cada paso"
                ];
            } else if (actualImprovementPercentage === 0) {
                level = "‚ö†Ô∏è Sin Mejora";
                color = "#f59e0b";
                message = `No se han corregido errores. Siguen existiendo ${originalErrors} errores (0% de mejora). El proceso ETL no est√° funcionando.`;
                nextSteps = [
                    "Verifica que el proceso ETL se est√© ejecutando correctamente",
                    "Revisa la configuraci√≥n de entrada y salida de datos",
                    "Comprueba que los componentes de limpieza est√©n activos",
                    "Considera redise√±ar completamente el flujo de transformaci√≥n"
                ];
            } else {
                level = "üö® Empeoramiento";
                color = "#dc2626";
                const additionalErrors = Math.abs(errorsCorrected);
                const totalErrorsNow = originalErrors + additionalErrors;
                message = `El proceso ha introducido ${additionalErrors} errores adicionales. Ahora hay ${totalErrorsNow} errores en total (${actualImprovementPercentage}% de empeoramiento). Requiere revisi√≥n inmediata.`;
                nextSteps = [
                    "Revisa urgentemente la configuraci√≥n del proceso ETL",
                    "Verifica que no se est√©n perdiendo datos durante la transformaci√≥n",
                    "Comprueba que los tipos de datos sean consistentes",
                    "Considera volver a la versi√≥n anterior y redise√±ar el proceso"
                ];
            }
            
            recommendationsDiv.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 12px; border-left: 5px solid ${color};">
                    <h4 style="color: ${color}; margin: 0 0 15px 0;">${level}</h4>
                    <p style="color: #374151; line-height: 1.6; margin-bottom: 20px; font-size: 1.1rem;">${message}</p>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #1f2937; margin: 0 0 15px 0;">üéØ Pr√≥ximos Pasos Recomendados:</h5>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            ${nextSteps.map(step => `<li style="color: #4b5563; margin-bottom: 8px;">${step}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-radius: 8px; border-left: 3px solid #2563eb;">
                        <strong style="color: #1e40af;">üí° Tip de Pentaho PDI:</strong>
                        <span style="color: #1e3a8a;">
                            ${actualImprovementPercentage >= 60.0 ? 
                                'Usa "Data Validator" para crear checkpoints de calidad en tu flujo ETL y mantener estos buenos resultados.' :
                                'Considera usar "Abort" steps para detener el proceso cuando se detecten errores cr√≠ticos y evitar propagaci√≥n de datos incorrectos.'
                            }
                        </span>
                    </div>
                </div>
            `;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992bd53ed140649a',t:'MTc2MTE2NTg3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
